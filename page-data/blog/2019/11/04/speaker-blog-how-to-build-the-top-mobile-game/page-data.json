{
    "componentChunkName": "component---src-templates-post-js",
    "path": "/blog/2019/11/04/speaker-blog-how-to-build-the-top-mobile-game/",
    "result": {"data":{"blog":{"html":"<div class=\"sect2\">\n<h3 id=\"context\"><a class=\"anchor\" href=\"#context\"></a>Context</h3>\n<div class=\"paragraph\">\n<p>You have been tasked with managing the Jenkins instance for the highest grossing mobile\ngame in the world. You learn that this involves helping the game studio iterate their work\nagainst eight different target platforms, each with their SDK, on four different main pipelines,\nplus a lot of extra auxiliary jobs. And, of course, the studio wants all of this to go smoothly, in\norder to maintain a good pace of features and bugfixes for every release - a release happening\nevery two weeks. Hitting hundreds of millions of players worldwide.</p>\n</div>\n<div class=\"paragraph\">\n<p>How are you going to make sure that the environment stays correctly configured, with the\nright versions of the required software; helping the studio maintain stability and scalability of\ntheir pipelines; ensuring operability of the Jenkins instance; improving the speed of the builds\nmonth after month?</p>\n</div>\n<div class=\"paragraph\">\n<p>It’s OK to sweat. You are going to need some help!</p>\n</div>\n<div class=\"paragraph\">\n<p>This is just a regular day in the office for a build engineer working at King. Facing a very\nbroad problem, with high quality standards and even higher stakes. Thankfully, we are not\nalone. We have access to a lot of tools - either open source tools, tools developed by the\nstudios or tools developed by our stellar build infrastructure team in Barcelona - to help carry\nus all the way to the publish line. We put all of these tools together, and by their powers\ncombined, we provide fast, easily operable workflows for the studios, cutting minutes here\nand there, ensuring the features a smooth sail from dev, to master, to release.</p>\n</div>\n<div class=\"paragraph\">\n<p>I will explain all of the tricks we use at King to speed builds up, and to make Jenkins operation\neasier for our studios on December 4, 2019, at <a href=\"https://www.cloudbees.com/devops-world/lisbon\">DevOps World | Jenkins\nWorld Lisbon</a>.\nUse <strong>JWFOSS</strong> for 30% discount on registration!\nFor now, let&#8217;s take a look at some of them.</p>\n</div>\n</div>\n<div class=\"sect2\">\n<h3 id=\"where-do-we-start\"><a class=\"anchor\" href=\"#where-do-we-start\"></a>Where do we start?</h3>\n<div class=\"paragraph\">\n<p>We use on-premises elastic infrastructure, spawning machines from certain templates\nwhenever they are needed. This means that for every build, we are getting a fresh\nenvironment - no intermediate artifacts leftover or anything of the sort, which is good. That\nalso means that we need to clone our repositories and compile everything every time, which is\nbad. However, we have solutions for these two problems.</p>\n</div>\n<div class=\"paragraph\">\n<p>We make full use of linkclones/snapshots when spawning a VM. Every night we run a\nbootstrapper that will power on the base image and perform whatever operations we decide on\nit, before turning it back into a template and re-creating the snapshot. In the case of Candy\nCrush, we update our caches, and this helps us cut some time off of git clone and compilation.\nWe call this bootstrapper “cacheo”. It looks more or less like this:</p>\n</div>\n<div class=\"listingblock\">\n<div class=\"title\">Cacheo</div>\n<div class=\"content\">\n<pre class=\"highlight nowrap\"><code class=\"language-groovy\" data-lang=\"groovy\">1. Start elastic agent template image\n2. Connect it to Jenkins\n3. Perform cleanup\n4. Trigger git reference cache jobs\n5. Trigger all the builds you want cached\n6. Turn off template image, delete the agent and recreate the linked clone snapshot</code></pre>\n</div>\n</div>\n<div class=\"paragraph\">\n<p>Every studio can specify on which templates will cacheo run, and what will it do in each of them.\nMaybe you want to make sure your Android license is on point. Or download some\npackages from artifactory. Perhaps pre-load your gradle dependencies. Whatever it is, cacheo\ndoes it for you and updates your base images every night.</p>\n</div>\n<div class=\"paragraph\">\n<p>One of the most common uses is to pre-fill a local git cache, and when doing so, the\nimprovement is very visible, especially on Windows:</p>\n</div>\n<table class=\"tableblock frame-all grid-all stretch\">\n<colgroup>\n<col style=\"width: 25%;\">\n<col style=\"width: 25%;\">\n<col style=\"width: 25%;\">\n<col style=\"width: 25%;\">\n</colgroup>\n<thead>\n<tr>\n<th class=\"tableblock halign-left valign-top\"></th>\n<th class=\"tableblock halign-left valign-top\">Linux</th>\n<th class=\"tableblock halign-left valign-top\">MacOS</th>\n<th class=\"tableblock halign-left valign-top\">Windows</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td class=\"tableblock halign-left valign-top\"><p class=\"tableblock\">NFS</p></td>\n<td class=\"tableblock halign-left valign-top\"><p class=\"tableblock\">2 min 11s</p></td>\n<td class=\"tableblock halign-left valign-top\"><p class=\"tableblock\">2min 34s</p></td>\n<td class=\"tableblock halign-left valign-top\"><p class=\"tableblock\">8min 32s</p></td>\n</tr>\n<tr>\n<td class=\"tableblock halign-left valign-top\"><p class=\"tableblock\">Local</p></td>\n<td class=\"tableblock halign-left valign-top\"><p class=\"tableblock\">1 min 20s</p></td>\n<td class=\"tableblock halign-left valign-top\"><p class=\"tableblock\">1min 35s</p></td>\n<td class=\"tableblock halign-left valign-top\"><p class=\"tableblock\">3min 49s</p></td>\n</tr>\n<tr>\n<td class=\"tableblock halign-left valign-top\"><p class=\"tableblock\">Difference</p></td>\n<td class=\"tableblock halign-left valign-top\"><p class=\"tableblock\"><strong>39% faster</strong></p></td>\n<td class=\"tableblock halign-left valign-top\"><p class=\"tableblock\"><strong>39% faster</strong></p></td>\n<td class=\"tableblock halign-left valign-top\"><p class=\"tableblock\"><strong>55% faster</strong></p></td>\n</tr>\n</tbody>\n</table>\n<div class=\"paragraph\">\n<p>This means, speeding up source code fetching by 55% on Windows, on average. That is a LOT!!</p>\n</div>\n</div>\n<div class=\"sect2\">\n<h3 id=\"but-what-about-actual-compilation\"><a class=\"anchor\" href=\"#but-what-about-actual-compilation\"></a>But what about actual compilation?</h3>\n<div class=\"paragraph\">\n<p>All of our major games use the same engine; we bring this code in by means of submodules. This means\nthere is a big bunch of shared code that needs to be compiled and linked whenever we build the game.\nAnd it&#8217;s not rare that this shared code is bigger than the actual game code!\nThankfully, the engine team lent us a hand, and they developed a way to package the compiled shared code.\nNormally, the game code lives alongside a specific version of the shared code, which doesn&#8217;t get updated too frequently.\nSometimes once a month, sometimes to grab a hotfix. This translates to us potentially compiling the\nexact same shared code for quite some time, every time we build the game. Thanks to these\nprebuilt artifacts, we are able to skip a huge part of the compilation, at the cost of a simple artifactory download.</p>\n</div>\n<div class=\"listingblock\">\n<div class=\"title\">Cacheo</div>\n<div class=\"content\">\n<pre class=\"highlight nowrap\"><code class=\"language-cmake\" data-lang=\"cmake\">if generate_prebuilt_libs:\n    compile_project()\n\n    generate_empty_cmakelists()\n\n    for dependency in dependencies:\n        merge_compiled_dependency_into_metalib(dependency)\n        write_dependency_to_generated_cmakelists_as_alias_for_metalib(dependency)\n\nelif use_prebuilt_libs:\n    add_generated_cmakelists_with_metalib_as_dependency()\n\n    compile_project()</code></pre>\n</div>\n</div>\n<div class=\"paragraph\">\n<p>Thanks to these prebuilt libraries, we are able to skip a big chunk of the compilation,\nand it builds up really quickly! Iterative work on several branches, as long as they have\nthe same engine version, gets sped up in noticeable ways.\nThere are, however, specific cases when we do choose to build the shared code regardless, such as\nwhen we build release candidates for instance.</p>\n</div>\n<div class=\"paragraph\">\n<p>Just so you get an idea, times on this table are on average:</p>\n</div>\n<table class=\"tableblock frame-all grid-all stretch\">\n<colgroup>\n<col style=\"width: 33.3333%;\">\n<col style=\"width: 33.3333%;\">\n<col style=\"width: 33.3334%;\">\n</colgroup>\n<thead>\n<tr>\n<th class=\"tableblock halign-left valign-top\"></th>\n<th class=\"tableblock halign-left valign-top\">iOS</th>\n<th class=\"tableblock halign-left valign-top\">Windows</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td class=\"tableblock halign-left valign-top\"><p class=\"tableblock\">No prebuilts</p></td>\n<td class=\"tableblock halign-left valign-top\"><p class=\"tableblock\">20min 17s</p></td>\n<td class=\"tableblock halign-left valign-top\"><p class=\"tableblock\">40min 30s</p></td>\n</tr>\n<tr>\n<td class=\"tableblock halign-left valign-top\"><p class=\"tableblock\">Prebuilts</p></td>\n<td class=\"tableblock halign-left valign-top\"><p class=\"tableblock\">10min 2s</p></td>\n<td class=\"tableblock halign-left valign-top\"><p class=\"tableblock\">23min 20s</p></td>\n</tr>\n<tr>\n<td class=\"tableblock halign-left valign-top\"><p class=\"tableblock\">Difference</p></td>\n<td class=\"tableblock halign-left valign-top\"><p class=\"tableblock\"><strong>51% faster</strong></p></td>\n<td class=\"tableblock halign-left valign-top\"><p class=\"tableblock\"><strong>43% faster</strong></p></td>\n</tr>\n</tbody>\n</table>\n</div>\n<div class=\"sect1\">\n<h2 id=\"i-just-dont-want-to-have-to-deal-with-bureaucracy\"><a class=\"anchor\" href=\"#i-just-dont-want-to-have-to-deal-with-bureaucracy\"></a>I just don&#8217;t want to have to deal with bureaucracy</h2>\n<div class=\"sectionbody\">\n<div class=\"paragraph\">\n<p>Operating Jenkins can be quite complicated. Talk about “Tell me\nsomething I don’t know”, right? And with so many moving pieces (elastic\ninfrastructure, plugins, dirty workspaces), it might not be easy for\neveryone to run specific maintenance tasks. We have a lot of small\npipelines, created by the build infrastructure group, that we can use to\ndiagnose and work around certain errors, as well as gather useful\ninformation that might be otherwise difficult to find. These pipelines\ndo things like printing all the installed plugins, deleting offline\non-demand agents, cleaning disconnected VMs from vSphere, or re-run\npuppet in a specific Jenkins instance. And any user can run these jobs,\nthere is no need to be an admin. This allows the team to unblock\nthemselves if they need to by using these jobs. Here&#8217;s one that I\nparticularly like. How many times have you modified a pipeline and, when\ntrying to run it, the first thing that happens is that Jenkins says that\nit needs approval?</p>\n</div>\n<div class=\"listingblock\">\n<div class=\"title\">Script Approval</div>\n<div class=\"content\">\n<pre class=\"highlight nowrap\"><code class=\"language-groovy\" data-lang=\"groovy\">import org.jenkinsci.plugins.scriptsecurity.scripts.*\n\n@NonCPS\n\n// Disclaimer - this can have serious security consequences\n// Be mindful when you run this!\n\ndef call() {\n    sa = ScriptApproval.get()\n    toApproveScripts = sa.getPendingScripts().collect()\n    println (\"toApproveScripts: \" + toApproveScripts)\n    toApproveScripts.each {pending -&gt;\n        sa.get().approveScript(pending.getHash())\n\tprintln (\"approvedScripts: \" + pending.getHash())\n\t}\n    sa.save()\n}</code></pre>\n</div>\n</div>\n<div class=\"paragraph\">\n<p>The best part? All our Jenkins instances include these jobs, by default, so\nno one misses out on the fun.</p>\n</div>\n</div>\n</div>","id":"d7cd86a9-cbed-5942-90a0-dd192dcd3459","title":"How to build the top mobile game for every platform imaginable","date":"2019-11-04T00:00:00.000Z","slug":"/blog/2019/11/04/speaker-blog-how-to-build-the-top-mobile-game/","links":{"discourse":""},"authors":[{"avatar":{"childImageSharp":{"gatsbyImageData":{"layout":"constrained","backgroundColor":"#483838","images":{"fallback":{"src":"/gatsby-jenkins-io/static/65fe0ac3c5bb3e4da27248b175dc5c31/19e71/ignacio_fernandez.jpg","srcSet":"/gatsby-jenkins-io/static/65fe0ac3c5bb3e4da27248b175dc5c31/77b35/ignacio_fernandez.jpg 32w,\n/gatsby-jenkins-io/static/65fe0ac3c5bb3e4da27248b175dc5c31/d4a57/ignacio_fernandez.jpg 64w,\n/gatsby-jenkins-io/static/65fe0ac3c5bb3e4da27248b175dc5c31/19e71/ignacio_fernandez.jpg 128w,\n/gatsby-jenkins-io/static/65fe0ac3c5bb3e4da27248b175dc5c31/68974/ignacio_fernandez.jpg 256w","sizes":"(min-width: 128px) 128px, 100vw"},"sources":[{"srcSet":"/gatsby-jenkins-io/static/65fe0ac3c5bb3e4da27248b175dc5c31/ef6ff/ignacio_fernandez.webp 32w,\n/gatsby-jenkins-io/static/65fe0ac3c5bb3e4da27248b175dc5c31/8257c/ignacio_fernandez.webp 64w,\n/gatsby-jenkins-io/static/65fe0ac3c5bb3e4da27248b175dc5c31/6766a/ignacio_fernandez.webp 128w,\n/gatsby-jenkins-io/static/65fe0ac3c5bb3e4da27248b175dc5c31/22bfc/ignacio_fernandez.webp 256w","type":"image/webp","sizes":"(min-width: 128px) 128px, 100vw"}]},"width":128,"height":128}}},"blog":null,"github":"Napo2k","html":"<div class=\"paragraph\">\n<p>Nacho is a Build Engineer with several years of experience in the videogame industry, and has worked in both AAA projects as well as free-to-play and mobile.\nCurrently, Nacho works at King Stockholm, taking care of Jenkins operations for Candy Crush Saga and Candy Crush Soda Saga.</p>\n</div>","id":"ignacio_fernandez","irc":null,"linkedin":"ignaciofernandezpuerta","name":"Ignacio 'Nacho' Fernández","slug":"/blog/authors/ignacio_fernandez","twitter":"@napo2k"}]}},"pageContext":{"next":"/blog/2019/11/08/board-elections/","previous":"/blog/2019/11/01/devops-world-jenkins-world-san-francisco-in-living-colors/","id":"d7cd86a9-cbed-5942-90a0-dd192dcd3459"}},
    "staticQueryHashes": ["1271460761","3649515864"]}