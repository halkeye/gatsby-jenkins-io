{
    "componentChunkName": "component---src-templates-post-js",
    "path": "/blog/2019/11/22/welcome-to-the-matrix/",
    "result": {"data":{"blog":{"html":"<div class=\"paragraph\">\n<p>I often find myself needing to run the same actions on a bunch of different configurations.\nUp to now, that meant I had to make multiple copies of the same stages in my pipelines.\nWhen I needed to make changes, I had to make the same changes in multiple places throughout my pipeline.\nMaintaining even a small number of configuration was difficult for larger pipelines.</p>\n</div>\n<div class=\"paragraph\">\n<p>Declarative Pipeline 1.5.0-beta1 (now available from the\n<a href=\"https://updates.jenkins.io/experimental/\">Jenkins Experimental Update site</a>) adds a new <code>matrix</code> section that lets me specify a list stages once and then run that same list in parallel on multiple configurations.\nLet&#8217;s take a look!</p>\n</div>\n<div class=\"sect1\">\n<h2 id=\"single-configuration-pipeline\"><a class=\"anchor\" href=\"#single-configuration-pipeline\"></a>Single configuration pipeline</h2>\n<div class=\"sectionbody\">\n<div class=\"paragraph\">\n<p>I&#8217;ll start with a simple pipeline with build and test stages.\nI&#8217;m using <code>echo</code> steps as placeholders for my build and test actions.</p>\n</div>\n<div class=\"listingblock\">\n<div class=\"title\">Jenkinsfile</div>\n<div class=\"content\">\n<pre class=\"highlight nowrap\"><code class=\"language-groovy\" data-lang=\"groovy\">pipeline {\n    agent none\n    stages {\n        stage('BuildAndTest') {\n            agent any\n            stages {\n                stage('Build') {\n                    steps {\n                        echo 'Do Build'\n                    }\n                }\n                stage('Test') {\n                    steps {\n                        echo 'Do Test'\n                    }\n                }\n            }\n        }\n    }\n}</code></pre>\n</div>\n</div>\n</div>\n</div>\n<div class=\"sect1\">\n<h2 id=\"pipeline-for-multiple-platforms-and-browsers\"><a class=\"anchor\" href=\"#pipeline-for-multiple-platforms-and-browsers\"></a>Pipeline for multiple platforms and browsers</h2>\n<div class=\"sectionbody\">\n<div class=\"paragraph\">\n<p>I&#8217;d like to run my build and tests on a combination of platforms and browsers.\nThe new <code>matrix</code> directive lets me specify a set of <code>axes</code>.\nEach <code>axis</code> has a <code>name</code> and a list of one or more <code>values</code>.\nWhen the pipeline is run, Jenkins will take those and run my stages on all possible combinations of values from each axis.\nAll cells in a matrix run in parallel (limited only by the number of available agents).\nStages within each cell are run sequentially.</p>\n</div>\n<div class=\"paragraph\">\n<p>My matrix has two axes: <code>PLATFORM</code> and <code>BROWSER</code>.\nI have three values for <code>PLATFORM</code> and four values for <code>BROWSER</code> resulting in my stages being run with twelve different combinations.\nI&#8217;ve changed my <code>echo</code> steps to use the axis values for each cell.</p>\n</div>\n<div class=\"listingblock\">\n<div class=\"title\">Jenkinsfile</div>\n<div class=\"content\">\n<pre class=\"highlight nowrap\"><code class=\"language-groovy\" data-lang=\"groovy\">pipeline {\n    agent none\n    stages {\n        stage('BuildAndTest') {\n            matrix {\n                agent any\n                axes {\n                    axis {\n                        name 'PLATFORM'\n                        values 'linux', 'windows', 'mac'\n                    }\n                    axis {\n                        name 'BROWSER'\n                        values 'firefox', 'chrome', 'safari', 'edge'\n                    }\n                }\n                stages {\n                    stage('Build') {\n                        steps {\n                            echo \"Do Build for ${PLATFORM} - ${BROWSER}\"\n                        }\n                    }\n                    stage('Test') {\n                        steps {\n                            echo \"Do Test for ${PLATFORM} - ${BROWSER}\"\n                        }\n                    }\n                }\n            }\n        }\n    }\n}</code></pre>\n</div>\n</div>\n<div class=\"listingblock\">\n<div class=\"title\">Log output (truncated)</div>\n<div class=\"content\">\n<pre class=\"highlight nowrap\"><code>...\n[Pipeline] stage\n[Pipeline] { (BuildAndTest)\n[Pipeline] parallel\n[Pipeline] { (Branch: Matrix - OS = 'linux', BROWSER = 'firefox')\n[Pipeline] { (Branch: Matrix - OS = 'windows', BROWSER = 'firefox')\n[Pipeline] { (Branch: Matrix - OS = 'mac', BROWSER = 'firefox')\n[Pipeline] { (Branch: Matrix - OS = 'linux', BROWSER = 'chrome')\n[Pipeline] { (Branch: Matrix - OS = 'windows', BROWSER = 'chrome')\n[Pipeline] { (Branch: Matrix - OS = 'mac', BROWSER = 'chrome')\n[Pipeline] { (Branch: Matrix - OS = 'linux', BROWSER = 'safari')\n[Pipeline] { (Branch: Matrix - OS = 'windows', BROWSER = 'safari')\n[Pipeline] { (Branch: Matrix - OS = 'mac', BROWSER = 'safari')\n[Pipeline] { (Branch: Matrix - OS = 'linux', BROWSER = 'edge') (hide)\n[Pipeline] { (Branch: Matrix - OS = 'windows', BROWSER = 'edge')\n[Pipeline] { (Branch: Matrix - OS = 'mac', BROWSER = 'edge')\n...\nDo Build for linux - safari\nDo Build for linux - firefox\nDo Build for windows - firefox\nDo Test for linux - firefox\nDo Build for mac - firefox\nDo Build for linux - chrome\nDo Test for windows - firefox\n...</code></pre>\n</div>\n</div>\n</div>\n</div>\n<div class=\"sect1\">\n<h2 id=\"excluding-invalid-combinations\"><a class=\"anchor\" href=\"#excluding-invalid-combinations\"></a>Excluding invalid combinations</h2>\n<div class=\"sectionbody\">\n<div class=\"paragraph\">\n<p>Now that I have my basic matrix created, I&#8217;ve noticed that I have some invalid combinations.\nMicrosoft Edge only runs on Windows and there isn&#8217;t a Linux version of Safari.</p>\n</div>\n<div class=\"paragraph\">\n<p>I can remove invalid cells from my matrix using <code>exclude</code> directives. Each <code>exclude</code> has one or more <code>axis</code> directives with <code>name</code> and <code>values</code>.\nThe <code>axis</code> directives inside an <code>exclude</code> generate a set of combinations (similar to generating the matrix cells).\nThe matrix cells that match all the values from an <code>exclude</code> combination are removed from the matrix.\nIf I have more than one <code>exclude</code> directive, each are evaluated separately to remove cells.</p>\n</div>\n<div class=\"paragraph\">\n<p>When dealing with a long lists of values to exclude, I can use <code>notValues</code> instead of <code>values</code> to specify axis values we <strong>don&#8217;t</strong> want excluded.\nYes, that&#8217;s a double negative, so it can get a little confusing.\nI try to use it only when I really need it.</p>\n</div>\n<div class=\"paragraph\">\n<p>In my sample pipeline below, I specifically exclude the <code>linux, safari</code> combination and I also exclude any platform that is <strong>not</strong> <code>windows</code> with the <code>edge</code> browser.</p>\n</div>\n<div class=\"admonitionblock important\">\n<table>\n<tr>\n<td class=\"icon\">\n<i class=\"fa icon-important\" title=\"Important\"></i>\n</td>\n<td class=\"content\">\n<div class=\"paragraph\">\n<p>This pipeline uses two axes but there is <strong>no limit</strong> on the number of <code>axis</code> directives.</p>\n</div>\n<div class=\"paragraph\">\n<p>Also, in this pipeline each <code>exclude</code> specifies values for both axes, but that is not required.\nIf we wanted to run only \"linux\" cells, we could use the following <code>exclude</code>:</p>\n</div>\n<div class=\"listingblock\">\n<div class=\"content\">\n<pre class=\"highlight nowrap\"><code class=\"language-groovy\" data-lang=\"groovy\">exclude {\n    axis {\n        name 'PLATFORM'\n        notValues 'linux'\n    }\n}</code></pre>\n</div>\n</div>\n</td>\n</tr>\n</table>\n</div>\n<div class=\"listingblock\">\n<div class=\"content\">\n<pre class=\"highlight nowrap\"><code class=\"language-groovy\" data-lang=\"groovy\">pipeline {\n    agent none\n    stages {\n        stage('BuildAndTest') {\n            matrix {\n                agent any\n                axes {\n                    axis {\n                        name 'PLATFORM'\n                        values 'linux', 'windows', 'mac'\n                    }\n                    axis {\n                        name 'BROWSER'\n                        values 'firefox', 'chrome', 'safari', 'edge'\n                    }\n                }\n                excludes {\n                    exclude {\n                        axis {\n                            name 'PLATFORM'\n                            values 'linux'\n                        }\n                        axis {\n                            name 'BROWSER'\n                            values 'safari'\n                        }\n                    }\n                    exclude {\n                        axis {\n                            name 'PLATFORM'\n                            notValues 'windows'\n                        }\n                        axis {\n                            name 'BROWSER'\n                            values 'edge'\n                        }\n                    }\n                }\n                stages {\n                    stage('Build') {\n                        steps {\n                            echo \"Do Build for ${PLATFORM} - ${BROWSER}\"\n                        }\n                    }\n                    stage('Test') {\n                        steps {\n                            echo \"Do Test for ${PLATFORM} - ${BROWSER}\"\n                        }\n                    }\n                }\n            }\n        }\n    }\n}</code></pre>\n</div>\n</div>\n<div class=\"listingblock\">\n<div class=\"title\">Log output (truncated)</div>\n<div class=\"content\">\n<pre class=\"highlight nowrap\"><code>...\n[Pipeline] stage\n[Pipeline] { (BuildAndTest)\n[Pipeline] parallel\n[Pipeline] { (Branch: Matrix - OS = 'linux', BROWSER = 'firefox')\n[Pipeline] { (Branch: Matrix - OS = 'windows', BROWSER = 'firefox')\n[Pipeline] { (Branch: Matrix - OS = 'mac', BROWSER = 'firefox')\n[Pipeline] { (Branch: Matrix - OS = 'linux', BROWSER = 'chrome')\n[Pipeline] { (Branch: Matrix - OS = 'windows', BROWSER = 'chrome')\n[Pipeline] { (Branch: Matrix - OS = 'mac', BROWSER = 'chrome')\n[Pipeline] { (Branch: Matrix - OS = 'windows', BROWSER = 'safari')\n[Pipeline] { (Branch: Matrix - OS = 'mac', BROWSER = 'safari')\n[Pipeline] { (Branch: Matrix - OS = 'windows', BROWSER = 'edge')\n...\nDo Build for linux - firefox\n...</code></pre>\n</div>\n</div>\n</div>\n</div>\n<div class=\"sect1\">\n<h2 id=\"controlling-cell-behavior-at-runtime\"><a class=\"anchor\" href=\"#controlling-cell-behavior-at-runtime\"></a>Controlling cell behavior at runtime</h2>\n<div class=\"sectionbody\">\n<div class=\"paragraph\">\n<p>Inside the <code>matrix</code> directive I can also add \"per-cell\" directives.\nThese are the same directives that I would add to a <code>stage</code> and they let me control the behavior of each cell in the matrix.\nThese directives can use the axis values from their cell as part of their inputs, allowing me to customize the behavior of each cell to match its axis values.</p>\n</div>\n<div class=\"paragraph\">\n<p>On my Jenkins server I have configured agents with labels that match the OS for each agent (\"linux-agent\", \"windows-agent\", and \"mac-agent\").\nTo run each cell in my matrix on the appropriate operating system, I configure the label for that cell using Groovy string templating.</p>\n</div>\n<div class=\"listingblock\">\n<div class=\"content\">\n<pre class=\"highlight nowrap\"><code class=\"language-groovy\" data-lang=\"groovy\">matrix {\n    axes { ... }\n    excludes { ... }\n    agent {\n        label \"${PLATFORM}-agent\"\n    }\n    stages { ... }\n    // ...\n}</code></pre>\n</div>\n</div>\n<div class=\"paragraph\">\n<p>Occasionally I run my pipeline manually from the Jenkins Web UI.\nWhen I do that, I&#8217;d like to be able to select just one platform to run.\nThe <code>axis</code> and <code>exclude</code> directives define the static set of cells that make up the matrix.\nThat set of combinations is generated before the start of the run, before any parameters are processed.\nWhat this means is that I can&#8217;t add or remove cells from a matrix after the job has started.</p>\n</div>\n<div class=\"paragraph\">\n<p>The \"per-cell\" directives, on the other hand, are evaluated at runtime.\nI can use the \"per-cell\" <code>when</code> directive inside <code>matrix</code> to control which cells in the matrix are executed.\nI&#8217;ll add a <code>choice</code> parameter with the list of platforms, and add conditions to the <code>when</code> directive, which will either let all platforms execute, or only execute cells that match my selected platform.</p>\n</div>\n<div class=\"listingblock\">\n<div class=\"content\">\n<pre class=\"highlight nowrap\"><code class=\"language-groovy\" data-lang=\"groovy\">pipeline {\n    parameters {\n        choice(name: 'PLATFORM_FILTER', choices: ['all', 'linux', 'windows', 'mac'], description: 'Run on specific platform')\n    }\n    agent none\n    stages {\n        stage('BuildAndTest') {\n            matrix {\n                agent {\n                    label \"${PLATFORM}-agent\"\n                }\n                when { anyOf {\n                    expression { params.PLATFORM_FILTER == 'all' }\n                    expression { params.PLATFORM_FILTER == env.PLATFORM }\n                } }\n                axes {\n                    axis {\n                        name 'PLATFORM'\n                        values 'linux', 'windows', 'mac'\n                    }\n                    axis {\n                        name 'BROWSER'\n                        values 'firefox', 'chrome', 'safari', 'edge'\n                    }\n                }\n                excludes {\n                    exclude {\n                        axis {\n                            name 'PLATFORM'\n                            values 'linux'\n                        }\n                        axis {\n                            name 'BROWSER'\n                            values 'safari'\n                        }\n                    }\n                    exclude {\n                        axis {\n                            name 'PLATFORM'\n                            notValues 'windows'\n                        }\n                        axis {\n                            name 'BROWSER'\n                            values 'edge'\n                        }\n                    }\n                }\n                stages {\n                    stage('Build') {\n                        steps {\n                            echo \"Do Build for ${PLATFORM} - ${BROWSER}\"\n                        }\n                    }\n                    stage('Test') {\n                        steps {\n                            echo \"Do Test for ${PLATFORM} - ${BROWSER}\"\n                        }\n                    }\n                }\n            }\n        }\n    }\n}</code></pre>\n</div>\n</div>\n<div class=\"paragraph\">\n<p>If I run this Pipeline from the Jenkins UI and set the <code>PLATFORM_FILTER</code> parameter to <code>mac</code>, I&#8217;ll get something like the output below:</p>\n</div>\n<div class=\"listingblock\">\n<div class=\"title\">Log output (truncated - PLATFORM_FILTER = 'mac' )</div>\n<div class=\"content\">\n<pre class=\"highlight nowrap\"><code>...\n[Pipeline] stage\n[Pipeline] { (BuildAndTest)\n[Pipeline] parallel\n[Pipeline] { (Branch: Matrix - OS = 'linux', BROWSER = 'firefox')\n[Pipeline] { (Branch: Matrix - OS = 'windows', BROWSER = 'firefox')\n[Pipeline] { (Branch: Matrix - OS = 'mac', BROWSER = 'firefox')\n[Pipeline] { (Branch: Matrix - OS = 'linux', BROWSER = 'chrome')\n[Pipeline] { (Branch: Matrix - OS = 'windows', BROWSER = 'chrome')\n[Pipeline] { (Branch: Matrix - OS = 'mac', BROWSER = 'chrome')\n[Pipeline] { (Branch: Matrix - OS = 'windows', BROWSER = 'safari')\n[Pipeline] { (Branch: Matrix - OS = 'mac', BROWSER = 'safari')\n[Pipeline] { (Branch: Matrix - OS = 'windows', BROWSER = 'edge')\n...\nStage \"Matrix - OS = 'linux', BROWSER = 'chrome'\" skipped due to when conditional\nStage \"Matrix - OS = 'linux', BROWSER = 'firefox'\" skipped due to when conditional\n...\nDo Build for mac - firefox\nDo Build for mac - chrome\nDo Build for mac - safari\n...\nStage \"Matrix - OS = 'windows', BROWSER = 'chrome'\" skipped due to when conditional\nStage \"Matrix - OS = 'windows', BROWSER = 'edge'\" skipped due to when conditional\n...\nDo Test for mac - safari\nDo Test for mac - firefox\nDo Test for mac - chrome</code></pre>\n</div>\n</div>\n<div class=\"admonitionblock important\">\n<table>\n<tr>\n<td class=\"icon\">\n<i class=\"fa icon-important\" title=\"Important\"></i>\n</td>\n<td class=\"content\">\nCome join me at <a href=\"https://www.cloudbees.com/devops-world/lisbon\">DevOps World | Jenkins World 2019</a> for \"<a href=\"https://sched.co/UeQe\"><strong>Declarative Pipeline 2019: Tips, Tricks and What&#8217;s Next</strong></a>\".\nI&#8217;ll go over what&#8217;s been added to Pipeline in the last year (including matrix) and discuss ideas about where pipeline should go next.\n</td>\n</tr>\n</table>\n</div>\n</div>\n</div>\n<div class=\"sect1\">\n<h2 id=\"conclusion\"><a class=\"anchor\" href=\"#conclusion\"></a>Conclusion</h2>\n<div class=\"sectionbody\">\n<div class=\"paragraph\">\n<p>In this blog post, we&#8217;ve looked at how to use the <code>matrix</code> directive to make concise but powerful declarative pipelines.\nAn equivalent pipeline created without <code>matrix</code> would easily be several times larger, and much harder to understand and maintain.</p>\n</div>\n<div class=\"paragraph\">\n<p>Matrix is now available from the experimental update center.\nIt will be released to the main update center as soon as we&#8217;re done putting the finishing touches on the documentation and online help.</p>\n</div>\n</div>\n</div>\n<div class=\"sect1\">\n<h2 id=\"links\"><a class=\"anchor\" href=\"#links\"></a>Links</h2>\n<div class=\"sectionbody\">\n<div class=\"ulist\">\n<ul>\n<li>\n<p><a href=\"https://updates.jenkins.io/experimental/\">Jenkins Experimental Update Center</a></p>\n</li>\n<li>\n<p><a href=\"https://jenkins.io/doc/developer/publishing/releasing-experimental-updates/#using-the-experimental-update-center\">Using the Jenkins Experimental Update Center</a></p>\n</li>\n</ul>\n</div>\n</div>\n</div>","id":"e5f5bc1a-7d2f-5807-8b41-7478e232a4f1","title":"Welcome to the Matrix","date":"2019-11-22T00:00:00.000Z","slug":"/blog/2019/11/22/welcome-to-the-matrix/","links":{"discourse":""},"authors":[{"avatar":{"childImageSharp":{"gatsbyImageData":{"layout":"constrained","backgroundColor":"#382818","images":{"fallback":{"src":"/gatsby-jenkins-io/static/9717c5c33fe8f4903eec2f2b5a8d1532/19e71/lnewman.jpg","srcSet":"/gatsby-jenkins-io/static/9717c5c33fe8f4903eec2f2b5a8d1532/77b35/lnewman.jpg 32w,\n/gatsby-jenkins-io/static/9717c5c33fe8f4903eec2f2b5a8d1532/d4a57/lnewman.jpg 64w,\n/gatsby-jenkins-io/static/9717c5c33fe8f4903eec2f2b5a8d1532/19e71/lnewman.jpg 128w,\n/gatsby-jenkins-io/static/9717c5c33fe8f4903eec2f2b5a8d1532/68974/lnewman.jpg 256w","sizes":"(min-width: 128px) 128px, 100vw"},"sources":[{"srcSet":"/gatsby-jenkins-io/static/9717c5c33fe8f4903eec2f2b5a8d1532/ef6ff/lnewman.webp 32w,\n/gatsby-jenkins-io/static/9717c5c33fe8f4903eec2f2b5a8d1532/8257c/lnewman.webp 64w,\n/gatsby-jenkins-io/static/9717c5c33fe8f4903eec2f2b5a8d1532/6766a/lnewman.webp 128w,\n/gatsby-jenkins-io/static/9717c5c33fe8f4903eec2f2b5a8d1532/22bfc/lnewman.webp 256w","type":"image/webp","sizes":"(min-width: 128px) 128px, 100vw"}]},"width":128,"height":128}}},"blog":null,"github":"bitwiseman","html":"<div class=\"paragraph\">\n<p>Liam started his software career as a tester, which might explain why he&#8217;s such a fan of CI/CD and Pipeline as Code.\nHe has spent the majority of his software engineering career implementing Continuous Integration systems at companies big and small.\nHe is a Jenkins project contributor and an expert in Jenkins Pipeline, both Scripted and Declarative.\nLiam currently works as a Jenkins Evangelist at <a href=\"https://cloudbees.com\">CloudBees</a>.\nWhen not at work, he enjoys testing gravity by doing Aikido.</p>\n</div>","id":"lnewman","irc":null,"linkedin":null,"name":"Liam Newman","slug":"/blog/authors/lnewman","twitter":"bitwiseman"}]}},"pageContext":{"next":"/blog/2019/11/25/macos-native-installer-deprecation/","previous":"/blog/2019/11/22/jenkins-health-advisor-by-cloudbees/","id":"e5f5bc1a-7d2f-5807-8b41-7478e232a4f1"}},
    "staticQueryHashes": ["1271460761","3649515864"]}