{
    "componentChunkName": "component---src-templates-post-js",
    "path": "/blog/2019/02/06/ssh-steps-for-jenkins-pipeline/",
    "result": {"data":{"blog":{"html":"<div class=\"paragraph\">\n<p><strong>Pipeline-as-code</strong> or defining the deployment pipeline through code rather than manual job creation through UI, provides tremendous benefits for teams automating builds and deployment infrastructure across their environments.</p>\n</div>\n<div class=\"paragraph\">\n<p><span class=\"image\"><img src=\"/gatsby-jenkins-io/images/pipeline/realworld-pipeline-flow.png\" alt=\"Pipeline Flow\" width=\"100%\"></span></p>\n</div>\n<div class=\"paragraph\">\n<p><em>Source of image: <a href=\"/doc/book/pipeline/\"><a href=\"https://jenkins.io/doc/book/pipeline/\" class=\"bare\">https://jenkins.io/doc/book/pipeline/</a></a></em></p>\n</div>\n<div class=\"sect1\">\n<h2 id=\"jenkins-pipelines\"><a class=\"anchor\" href=\"#jenkins-pipelines\"></a>Jenkins Pipelines</h2>\n<div class=\"sectionbody\">\n<div class=\"paragraph\">\n<p><a href=\"https://jenkins.io/\">Jenkins</a> is a well-known open source continuous integration and continuous deployment automation tool. With the latest 2.0 release, Jenkins introduced the Pipeline plugin that implements Pipeline-as-code. This plugin lets you define delivery pipelines using concise scripts which deal elegantly with jobs involving persistence and asynchrony.</p>\n</div>\n<div class=\"paragraph\">\n<p>The Pipeline-as-code&#8217;s script is also known as a <em>Jenkinsfile</em>.</p>\n</div>\n<div class=\"paragraph\">\n<p>Jenkinsfiles uses a domain specific language syntax based on the <a href=\"http://groovy-lang.org/\">Groovy</a> programming language. They are persistent files which can be checked in and version-controlled along with the rest of their project source code. This file can contain the complete set of encoded steps (steps, nodes, and stages) necessary to define the entire application life-cycle, becoming the intersecting point between development and operations.</p>\n</div>\n<div class=\"sect2\">\n<h3 id=\"missing-piece-of-the-puzzle\"><a class=\"anchor\" href=\"#missing-piece-of-the-puzzle\"></a>Missing piece of the puzzle</h3>\n<div class=\"paragraph\">\n<p>One of the most common steps defined in a basic pipeline job is the <em>Deploy</em> step. The deployment stage encompasses everything from publishing build artifacts to pushing code into pre-production and production environments. This deployment stage usually involves both development and operations teams logging onto various remote nodes to run commands and/or scripts to deploy code and configuration. While there are a couple of existing ssh plugins for Jenkins, they currently don&#8217;t support the functionality such as logging into nodes for pipelines. Thus, there was a need for a plugin that supports these steps.</p>\n</div>\n</div>\n</div>\n</div>\n<div class=\"sect1\">\n<h2 id=\"introducing-ssh-steps\"><a class=\"anchor\" href=\"#introducing-ssh-steps\"></a>Introducing SSH Steps</h2>\n<div class=\"sectionbody\">\n<div class=\"imageblock center\">\n<div class=\"content\">\n<img src=\"/images/post-images/2019-02-06-ssh-steps/JenkinsPlusSSH.png\" alt=\"SSH Steps\">\n</div>\n</div>\n<div class=\"paragraph\">\n<p>Recently, our team at Cerner started working on a project to automate deployments through Jenkins pipelines to help facilitate running commands on over one thousand nodes. We looked at several options including existing plugins, internal shared Jenkins libraries, and others. In the end, we felt it was best to create and open source a plugin to fill this gap so that it can be used across Cerner and beyond.</p>\n</div>\n<div class=\"paragraph\">\n<p>The initial version of this new plugin SSH Steps supports the following:</p>\n</div>\n<div class=\"ulist\">\n<ul>\n<li>\n<p><code>sshCommand</code>: Executes the given command on a remote node.</p>\n</li>\n<li>\n<p><code>sshScript</code>: Executes the given shell script on a remote node.</p>\n</li>\n<li>\n<p><code>sshGet</code>: Gets a file/directory from the remote node to current workspace.</p>\n</li>\n<li>\n<p><code>sshPut</code>: Puts a file/directory from the current workspace to remote node.</p>\n</li>\n<li>\n<p><code>sshRemove</code>: Removes a file/directory from the remote node.</p>\n</li>\n</ul>\n</div>\n<div class=\"sect2\">\n<h3 id=\"usage\"><a class=\"anchor\" href=\"#usage\"></a>Usage</h3>\n<div class=\"paragraph\">\n<p>Below is a simple demonstration on how to use above steps. More documentation can be found on <a href=\"https://github.com/jenkinsci/ssh-steps-plugin/blob/master/README.adoc\">GitHub</a>.</p>\n</div>\n<div class=\"listingblock\">\n<div class=\"content\">\n<pre class=\"highlight nowrap\"><code class=\"language-groovy\" data-lang=\"groovy\">def remote = [:]\nremote.name = \"node\"\nremote.host = \"node.abc.com\"\nremote.allowAnyHosts = true\n\nnode {\n    withCredentials([usernamePassword(credentialsId: 'sshUserAcct', passwordVariable: 'password', usernameVariable: 'userName')]) {\n        remote.user = userName\n        remote.password = password\n\n        stage(\"SSH Steps Rocks!\") {\n            writeFile file: 'test.sh', text: 'ls'\n            sshCommand remote: remote, command: 'for i in {1..5}; do echo -n \\\"Loop \\$i \\\"; date ; sleep 1; done'\n            sshScript remote: remote, script: 'test.sh'\n            sshPut remote: remote, from: 'test.sh', into: '.'\n            sshGet remote: remote, from: 'test.sh', into: 'test_new.sh', override: true\n            sshRemove remote: remote, path: 'test.sh'\n        }\n    }\n}</code></pre>\n</div>\n</div>\n</div>\n<div class=\"sect2\">\n<h3 id=\"configuring-via-yaml\"><a class=\"anchor\" href=\"#configuring-via-yaml\"></a>Configuring via YAML</h3>\n<div class=\"paragraph\">\n<p>At Cerner, we always strive to have simple configuration files for CI/CD pipelines whenever possible. With that in mind, my team built a wrapper on top of these steps from this plugin. After some design and analysis, we came up with the following YAML structure to run commands across various remote groups:</p>\n</div>\n<div class=\"listingblock\">\n<div class=\"content\">\n<pre class=\"highlight nowrap\"><code class=\"language-yaml\" data-lang=\"yaml\">config:\n  credentials_id: sshUserAcct\n\nremote_groups:\n  r_group_1:\n    - name: node01\n      host: node01.abc.net\n    - name: node02\n      host: node02.abc.net\n  r_group_2:\n    - name: node03\n      host: node03.abc.net\n\ncommand_groups:\n  c_group_1:\n    - commands:\n        - 'ls -lrt'\n        - 'whoami'\n    - scripts:\n        - 'test.sh'\n  c_group_2:\n    - gets:\n        - from: 'test.sh'\n          to: 'test_new.sh'\n    - puts:\n        - from: 'test.sh'\n          to: '.'\n    - removes:\n        - 'test.sh'\n\nsteps:\n  deploy:\n    - remote_groups:\n        - r_group_1\n      command_groups:\n        - c_group_1\n    - remote_groups:\n        - r_group_2\n      command_groups:\n        - c_group_2</code></pre>\n</div>\n</div>\n<div class=\"paragraph\">\n<p>The above example runs commands from <code>c_group_1</code> on remote nodes within <code>r_group_1</code> in parallel before it moves on to the next group using <code>sshUserAcct</code> (from the <a href=\"https://jenkins.io/doc/book/using/using-credentials/\">Jenkins Credentials</a> store) to logon to nodes.</p>\n</div>\n</div>\n<div class=\"sect2\">\n<h3 id=\"shared-pipeline-library\"><a class=\"anchor\" href=\"#shared-pipeline-library\"></a>Shared Pipeline Library</h3>\n<div class=\"paragraph\">\n<p>We have created a shared pipeline library that contains a <code>sshDeploy</code> step to support the above mentioned YAML syntax. Below is the code snippet for the sshDeploy step from the library. The full version can be found <a href=\"https://github.com/nrayapati/ssh-deploy-library\">here</a> on Github.</p>\n</div>\n<div class=\"listingblock\">\n<div class=\"content\">\n<pre class=\"highlight nowrap\"><code class=\"language-groovy\" data-lang=\"groovy\">#!/usr/bin/groovy\ndef call(String yamlName) {\n    def yaml = readYaml file: yamlName\n    withCredentials([usernamePassword(credentialsId: yaml.config.credentials_id, passwordVariable: 'password', usernameVariable: 'userName')]) {\n        yaml.steps.each { stageName, step -&gt;\n            step.each {\n                def remoteGroups = [:]\n                def allRemotes = []\n                it.remote_groups.each {\n                    remoteGroups[it] = yaml.remotes.\"$it\"\n                }\n\n                def commandGroups = [:]\n                it.command_groups.each {\n                    commandGroups[it] = yaml.commands.\"$it\"\n                }\n                def isSudo = false\n                remoteGroups.each { remoteGroupName, remotes -&gt;\n                    allRemotes += remotes.collect { remote -&gt;\n                        if(!remote.name)\n                            remote.name = remote.host\n                        remote.user = userName\n                        remote.password = password\n                        remote.allowAnyHosts = true\n                        remote.groupName = remoteGroupName\n                        remote\n                    }\n                }\n                if(allRemotes) {\n                    if(allRemotes.size() &gt; 1) {\n                        def stepsForParallel = allRemotes.collectEntries { remote -&gt;\n                            [\"${remote.groupName}-${remote.name}\" : transformIntoStep(stageName, remote.groupName, remote, commandGroups)]\n                        }\n                        stage(stageName) {\n                            parallel stepsForParallel\n                        }\n                    } else {\n                        def remote = allRemotes.first()\n                        stage(stageName + \"\\n\" + remote.groupName + \"-\" + remote.name) {\n                            transformIntoStep(stageName, remote.groupName, remote, commandGroups).call()\n                        }\n                    }\n                }\n            }\n        }\n    }\n}</code></pre>\n</div>\n</div>\n<div class=\"paragraph\">\n<p>By using the step (as described in the snippet above) from this shared pipeline library, a Jenkinsfile can be reduced to:</p>\n</div>\n<div class=\"listingblock\">\n<div class=\"content\">\n<pre class=\"highlight nowrap\"><code class=\"language-groovy\" data-lang=\"groovy\">@Library('ssh_deploy') _\n\nnode {\n  checkout scm\n  sshDeploy('dev/deploy.yml');\n}</code></pre>\n</div>\n</div>\n<div class=\"paragraph\">\n<p>An example execution of the above pipeline code in Blue Ocean looks like this:</p>\n</div>\n<div class=\"imageblock center\">\n<div class=\"content\">\n<img src=\"/images/post-images/2019-02-06-ssh-steps/jenkins-ssh-deploy.png\" alt=\"SSH Deploy BlueOcean View\" width=\"80%\">\n</div>\n</div>\n</div>\n<div class=\"sect2\">\n<h3 id=\"wrapping-up\"><a class=\"anchor\" href=\"#wrapping-up\"></a>Wrapping up</h3>\n<div class=\"paragraph\">\n<p>Steps from the <a href=\"https://github.com/jenkinsci/ssh-steps-plugin\">SSH Steps Plugin</a> are deliberately generic enough that they can be used for various other use-cases as well, not just for deploying code. Using SSH Steps has significantly reduced the time we spend on deployments and has given us the possibility of easily scaling our deployment workflows to various environments.</p>\n</div>\n<div class=\"paragraph\">\n<p>Help us make this <a href=\"https://github.com/jenkinsci/ssh-steps-plugin\">plugin</a> better by contributing. Whether it is adding or suggesting a new feature, bug fixes, or simply improving documentation, contributions are always welcome.</p>\n</div>\n</div>\n</div>\n</div>","id":"ed5dfb33-f5e6-565b-a671-f4ae47d2c691","title":"SSH Steps for Jenkins Pipeline","date":"2019-02-06T00:00:00.000Z","slug":"/blog/2019/02/06/ssh-steps-for-jenkins-pipeline/","links":{"discourse":""},"authors":[{"avatar":{"childImageSharp":{"gatsbyImageData":{"layout":"constrained","backgroundColor":"#281818","images":{"fallback":{"src":"/gatsby-jenkins-io/static/4aea26279158324c14a34104f2df9d81/19e71/nrayapati.jpg","srcSet":"/gatsby-jenkins-io/static/4aea26279158324c14a34104f2df9d81/77b35/nrayapati.jpg 32w,\n/gatsby-jenkins-io/static/4aea26279158324c14a34104f2df9d81/d4a57/nrayapati.jpg 64w,\n/gatsby-jenkins-io/static/4aea26279158324c14a34104f2df9d81/19e71/nrayapati.jpg 128w,\n/gatsby-jenkins-io/static/4aea26279158324c14a34104f2df9d81/68974/nrayapati.jpg 256w","sizes":"(min-width: 128px) 128px, 100vw"},"sources":[{"srcSet":"/gatsby-jenkins-io/static/4aea26279158324c14a34104f2df9d81/ef6ff/nrayapati.webp 32w,\n/gatsby-jenkins-io/static/4aea26279158324c14a34104f2df9d81/8257c/nrayapati.webp 64w,\n/gatsby-jenkins-io/static/4aea26279158324c14a34104f2df9d81/6766a/nrayapati.webp 128w,\n/gatsby-jenkins-io/static/4aea26279158324c14a34104f2df9d81/22bfc/nrayapati.webp 256w","type":"image/webp","sizes":"(min-width: 128px) 128px, 100vw"}]},"width":128,"height":128}}},"blog":null,"github":"nrayapati","html":"<div class=\"paragraph\">\n<p>Software Architect at <a href=\"https://www.cerner.com/\">Cerner Corporation</a>. Passionate about Agile, DevOps &amp; Continuous Delivery, and all things Automation.\nOSS Contributor, he is maintaining couple of Jenkins plugins since past several years. <a href=\"https://plugins.jenkins.io/ssh-steps\">SSH Steps</a> - <a href=\"https://plugins.jenkins.io/jira-steps\">JIRA Steps</a> - <a href=\"https://plugins.jenkins.io/hubot-steps\">Hubot Steps</a></p>\n</div>","id":"nrayapati","irc":null,"linkedin":null,"name":"Naresh Rayapati","slug":"/blog/authors/nrayapati","twitter":"nrayapati"}]}},"pageContext":{"next":"/blog/2019/02/17/remoting-cli-removed/","previous":"/blog/2019/02/05/jenkins-new-year-in-china/","id":"ed5dfb33-f5e6-565b-a671-f4ae47d2c691"}},
    "staticQueryHashes": ["1271460761","3649515864"]}