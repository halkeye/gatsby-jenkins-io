{
    "componentChunkName": "component---src-templates-post-js",
    "path": "/blog/2016/12/20/jenkins-puppet-enterprise-plugin/",
    "result": {"data":{"blog":{"html":"<div class=\"admonitionblock note\">\n<table>\n<tr>\n<td class=\"icon\">\n<i class=\"fa icon-note\" title=\"Note\"></i>\n</td>\n<td class=\"content\">\n<div class=\"paragraph\">\n<p>This is a guest post by <a href=\"https://github.com/ccaum\">Carl Caum</a>,\nwho works at <a href=\"https://puppet.com\">Puppet</a> and created the\n<a href=\"https://plugins.jenkins.io/puppet-enterprise-pipeline\">Puppet Enterprise Pipeline plugin</a>.</p>\n</div>\n</td>\n</tr>\n</table>\n</div>\n<div class=\"paragraph\">\n<p>During PuppetConf 2016, myself and Brian Dawson from CloudBees announced the\nplugin:puppet-enterprise-pipeline[Puppet Enterprise\nplugin for Jenkins Pipeline].\nLet&#8217;s take a look at how the plugin makes it trivial to use Puppet to perform\nsome or all of the deployment tasks in continuous delivery pipelines.</p>\n</div>\n<div class=\"paragraph\">\n<p>Jenkins Pipeline introduced an amazing world where the definition for a\npipeline is managed from the same version control repository as the code\ndelivered by the pipeline. This is a powerful idea, and one I felt complemented\nPuppet&#8217;s automation strengths. I wanted to make it trivial to control Puppet\nEnterprise&#8217;s orchestration and infrastructure code management capabilities, as\nwell as set hierarchical configuration data and use Puppet&#8217;s inventory data\nsystem as a source of truth â€“ all from a Pipeline script. The result was the\nPuppet Enterprise plugin, which fully buys into the Pipeline ideals by\nproviding methods to control the different capabilities in Puppet Enterprise.\nThe methods provide ways to query\n<a href=\"https://docs.puppet.com/puppetdb/4.3/\">PuppetDB</a>, set\n<a href=\"https://docs.puppet.com/hiera/3.2/\">Hiera</a> key/value pairs, deploy\nPuppet code environments with\n<a href=\"https://docs.puppet.com/pe/latest/code_mgr.html\">Code Management</a>, and kick off orchestrated Puppet runs with the\n<a href=\"https://docs.puppet.com/pe/latest/app_orchestration_overview.html\">Orchestrator</a>.</p>\n</div>\n<div class=\"sect1\">\n<h2 id=\"the-puppet-enterprise-for-jenkins-pipeline-plugin\"><a class=\"anchor\" href=\"#the-puppet-enterprise-for-jenkins-pipeline-plugin\"></a>The Puppet Enterprise for Jenkins Pipeline plugin</h2>\n<div class=\"sectionbody\">\n<div class=\"paragraph\">\n<p>The Puppet Enterprise for Jenkins Pipeline plugin itself has zero system\ndependencies. You need only to install the plugin from the update center. The\nplugin uses APIs available in Puppet Enterprise to do its work. Since the\nPuppetDB query, Code Management, and Orchestrator APIs are all\nbacked by Puppet Enterprise&#8217;s role-based access control (RBAC) system, it&#8217;s\neasy to restrict what pipelines are allowed to control in Puppet Enterprise. To\nlearn more about RBAC in Puppet Enterprise,\n<a href=\"https://docs.puppet.com/pe/latest/rbac_intro.html\">read the docs here.</a></p>\n</div>\n</div>\n</div>\n<div class=\"sect1\">\n<h2 id=\"configuring\"><a class=\"anchor\" href=\"#configuring\"></a>Configuring</h2>\n<div class=\"sectionbody\">\n<div class=\"paragraph\">\n<p>Configuring the plugin is fairly straight forward. It takes three simple steps:</p>\n</div>\n<div class=\"olist arabic\">\n<ol class=\"arabic\">\n<li>\n<p>Set the address of the Puppet server</p>\n</li>\n<li>\n<p>Create a Jenkins credential with a Pupppet Enterprise RBAC authentication token</p>\n</li>\n<li>\n<p>Configure the Hiera backend</p>\n</li>\n</ol>\n</div>\n<div class=\"sect2\">\n<h3 id=\"set-the-puppet-enterprise-server-address\"><a class=\"anchor\" href=\"#set-the-puppet-enterprise-server-address\"></a>Set the Puppet Enterprise Server Address</h3>\n<div class=\"paragraph\">\n<p>Go to Jenkins &gt; Manage Jenkins &gt; Puppet Enterprise page. Put the DNS address of\nthe Puppet server in the <strong>Puppet Master Address</strong> text field. Click the <strong>Test\nConnection</strong> button to verify the server is reachable, the Puppet CA certificate\nis retrievable, and HTTPS connections are successful. Once the test succeeds,\nClick <strong>Save</strong>.</p>\n</div>\n</div>\n<div class=\"sect2\">\n<h3 id=\"create-a-jenkins-credentials-entry\"><a class=\"anchor\" href=\"#create-a-jenkins-credentials-entry\"></a>Create a Jenkins Credentials Entry</h3>\n<div class=\"paragraph\">\n<p>The plugin uses the Jenkins built-in credentials system (the plain-credentials\nplugin) to store and refer RBAC tokens to Puppet Enterprise for authentication\nand authorization. First, generate an RBAC token in Puppet Enterprise by\nfollowing\n<a href=\"https://docs.puppet.com/pe/latest/rbac_token_auth.html#generating-a-token-for-use-by-a-service\">the\ninstructions on the docs site.</a> Next, create a new Jenkins Credentials item\nwith Kind <strong>Secret text</strong> and the <strong>Secret</strong> value the Puppet Enterprise RBAC\ntoken. It&#8217;s highly recommended to give the credential an ID value that&#8217;s\ndescriptive and identifiable. You&#8217;ll use it in your Pipeline scripts.</p>\n</div>\n<div class=\"paragraph\">\n<p>In your Jenkinsfile, use the <code>puppet.credentials</code> method to set all future Puppet\nmethods to use the RBAC token. For example:</p>\n</div>\n<div class=\"listingblock\">\n<div class=\"content\">\n<pre class=\"highlight nowrap\"><code class=\"language-groovy\" data-lang=\"groovy\">puppet.credentials 'pe-team-token'</code></pre>\n</div>\n</div>\n</div>\n<div class=\"sect2\">\n<h3 id=\"configure-the-hiera-backend\"><a class=\"anchor\" href=\"#configure-the-hiera-backend\"></a>Configure the Hiera Backend</h3>\n<div class=\"paragraph\">\n<p>The plugin exposes an HTTP API for performing Hiera data lookups for key/value\npairs managed by Pipeline jobs. To configure Hiera on the Puppet compile\nmaster(s) to query the Jenkins Hiera data store backend, use the\n<a href=\"https://github.com/crayfishx/hiera-http\">hiera-http</a> backend. On the\nPuppet Enterprise compile master(s), run the following commands:</p>\n</div>\n<div class=\"listingblock\">\n<div class=\"content\">\n<pre class=\"nowrap\">/opt/puppetlabs/puppet/bin/gem install hiera-http\n/opt/puppetlabs/bin/puppetserver gem install hiera-http</pre>\n</div>\n</div>\n<div class=\"paragraph\">\n<p>Now you can configure the /etc/puppetlabs/puppet/hiera.yaml file. The following\nconfiguration instructs Hiera to first look to the Hiera yaml files in the\nPuppet code&#8217;s environment, then fall back to the http backend. The http backend\nwill first query the Hiera data store API looking for the key in the scope with\nthe same name as the node. If nothing&#8217;s found, look for the key in the node&#8217;s\nenvironments. You can use any Facter fact to match scope names.</p>\n</div>\n<div class=\"listingblock\">\n<div class=\"content\">\n<pre class=\"nowrap\">:backends:\n  - yaml\n  - http\n\n:http:\n  :host: jenkins.example.com\n  :port: 8080\n  :output: json\n  :use_auth: true\n  :auth_user: &lt;user&gt;\n  :auth_pass: &lt;pass&gt;\n  :cache_timeout: 10\n  :failure: graceful\n  :paths:\n    - /hiera/lookup?path=%{clientcert}&amp;key=%{key}\n    - /hiera/lookup?path=%{environment}&amp;key=%{key}</pre>\n</div>\n</div>\n<div class=\"paragraph\">\n<p>Finally, restart the pe-puppetserver process to pick up the new configs:</p>\n</div>\n<div class=\"listingblock\">\n<div class=\"content\">\n<pre class=\"nowrap\">/opt/puppetlabs/bin/puppet resource service pe-puppetserver ensure=stopped\n/opt/puppetlabs/bin/puppet resource service pe-puppetserver ensure=running</pre>\n</div>\n</div>\n<div class=\"sect3\">\n<h4 id=\"hiera-http-authentication\"><a class=\"anchor\" href=\"#hiera-http-authentication\"></a>Hiera HTTP Authentication</h4>\n<div class=\"paragraph\">\n<p>If Jenkins' Global Security is configured to allow unauthenticated read-only\naccess, the 'use_auth', 'auth_pass', and 'auth_user' parameters are\nunnecessary. Otherwise, create a local Jenkins user that has permissions to\nview the Hiera Data Lookup page and use that user&#8217;s credentials for the\nhiera.yaml configuration.</p>\n</div>\n</div>\n</div>\n</div>\n</div>\n<div class=\"sect1\">\n<h2 id=\"querying-the-infrastructure\"><a class=\"anchor\" href=\"#querying-the-infrastructure\"></a>Querying the infrastructure</h2>\n<div class=\"sectionbody\">\n<div class=\"paragraph\">\n<p>PuppetDB is an extensive data store that holds every bit of information Puppet\ngenerates and collects across every system Puppet is installed on. PuppetDB\nprovides a sweet query language called\n<a href=\"https://docs.puppet.com/puppetdb/4.3/api/query/v4/pql.html\">PQL.</a> With PQL,\nyou can ask complex questions of your infrastructure such as \"How many\nproduction Red Hat systems are there with the openssl package installed?\" or\n\"What us-west-2c nodes with the MyApp role that were created in the last 24\nhours?\"</p>\n</div>\n<div class=\"paragraph\">\n<p>This can be a powerful tool for parts of your pipeline where you need to\nperform specific operations on subsets of the infrastructure like draining a\nloadbalancer.</p>\n</div>\n<div class=\"paragraph\">\n<p>Here&#8217;s an example using the <code>puppet.query</code> method:</p>\n</div>\n<div class=\"listingblock\">\n<div class=\"content\">\n<pre class=\"highlight nowrap\"><code class=\"language-groovy\" data-lang=\"groovy\">results = puppet.query '''\n  inventory[certname] {\n    facts.os.name = \"RedHat\" and\n    facts.ec2_metadata.placement.availability-zone = \"us-west-2c\" and\n    facts.uptime_hours &lt; 24\n  }'''</code></pre>\n</div>\n</div>\n<div class=\"paragraph\">\n<p>The query returns an array of matching items. The results can be\niterated on, and even passed to a series of <code>puppet.job</code> calls. For example, the\nfollowing code will query all nodes in production that experienced a failure on\nthe last Puppet run.</p>\n</div>\n<div class=\"listingblock\">\n<div class=\"content\">\n<pre class=\"highlight nowrap\"><code class=\"language-groovy\" data-lang=\"groovy\">results = puppet.query 'nodes { latest_report_status = \"failed\" and catalog_environment = \"production\"}'</code></pre>\n</div>\n</div>\n<div class=\"paragraph\">\n<p>Note that once you can use closures in Pipeline scripts, doing the above\nexample will be much simpler.</p>\n</div>\n</div>\n</div>\n<div class=\"sect1\">\n<h2 id=\"creating-an-orchestrator-job\"><a class=\"anchor\" href=\"#creating-an-orchestrator-job\"></a>Creating an orchestrator job</h2>\n<div class=\"sectionbody\">\n<div class=\"paragraph\">\n<p>The orchestration service in Puppet Enterprise is a tool to perform\norchestrated Puppet runs across as broad or as targeted an infrastructure as\nyou need at different parts of a pipeline. You can use the orchestrator to\nupdate applications in an environment, or update a specific list of nodes, or\nupdate nodes across a set of nodes that match certain criteria. In each\nscenario, Puppet will always push distributed changes in the correct order by\nrespecting the cross-node dependencies.</p>\n</div>\n<div class=\"paragraph\">\n<p>To create a job in the Puppet orchestrator from a Jenkins pipeline, use the\n<code>puppet.job</code> method. The <code>puppet.job</code> method will create a new orchestrator job,\nmonitor the job for completion, and determine if any Puppet runs failed. If\nthere were failures, the pipeline will fail.</p>\n</div>\n<div class=\"paragraph\">\n<p>The following are just some examples of how to run Puppet orchestration jobs against the infrastructure you need to target.</p>\n</div>\n<div class=\"paragraph\">\n<p>Target an entire environment:</p>\n</div>\n<div class=\"listingblock\">\n<div class=\"content\">\n<pre class=\"highlight nowrap\"><code class=\"language-groovy\" data-lang=\"groovy\">puppet.job 'production'</code></pre>\n</div>\n</div>\n<div class=\"paragraph\">\n<p>Target instances of an application in production:</p>\n</div>\n<div class=\"listingblock\">\n<div class=\"content\">\n<pre class=\"highlight nowrap\"><code class=\"language-groovy\" data-lang=\"groovy\">puppet.job 'production', application: 'Myapp'</code></pre>\n</div>\n</div>\n<div class=\"paragraph\">\n<p>Target a specific list of nodes:</p>\n</div>\n<div class=\"listingblock\">\n<div class=\"content\">\n<pre class=\"highlight nowrap\"><code class=\"language-groovy\" data-lang=\"groovy\">puppet.job 'production', nodes: ['db.example.com','appserver01.example.com','appserver02.example.com']</code></pre>\n</div>\n</div>\n<div class=\"paragraph\">\n<p>Target nodes matching a complex set if criteria:</p>\n</div>\n<div class=\"listingblock\">\n<div class=\"content\">\n<pre class=\"highlight nowrap\"><code class=\"language-groovy\" data-lang=\"groovy\">puppet.job 'production', query: 'inventory[certname] { facts.os.name = \"RedHat\" and facts.ec2_metadata.placement.availability-zone = \"us-west-2c\" and uptime_hours &lt; 24 }'</code></pre>\n</div>\n</div>\n<div class=\"paragraph\">\n<p>As you can see, the <code>puppet.job</code> command means you can be as broad or as targeted\nas you need to be for different parts of your pipeline. There are many other\noptions you can add to the <code>puppet.job</code> method call, such as setting the Puppet\nruns to noop, or giving the orchestrator a maximum concurrency limit.\n<a href=\"https://puppet.com/product/capabilities/application-orchestration\">Learn\nmore about the orchestrator here.</a></p>\n</div>\n</div>\n</div>\n<div class=\"sect1\">\n<h2 id=\"updating-puppet-code\"><a class=\"anchor\" href=\"#updating-puppet-code\"></a>Updating Puppet code</h2>\n<div class=\"sectionbody\">\n<div class=\"paragraph\">\n<p>If you&#8217;re using Code Management in Puppet Enterprise (and you should), you can\nensure that all the modules, site manifests, Hiera data, and roles and profiles\nare staged, synced, and ready across all your Puppet masters, direct from your\nJenkins pipeline.</p>\n</div>\n<div class=\"paragraph\">\n<p>To update Puppet code across all Puppet masters, use the <code>puppet.codeDeploy</code> method:</p>\n</div>\n<div class=\"listingblock\">\n<div class=\"content\">\n<pre class=\"highlight nowrap\"><code class=\"language-groovy\" data-lang=\"groovy\">puppet.codeDeploy 'staging'</code></pre>\n</div>\n</div>\n<div class=\"paragraph\">\n<p><a href=\"https://puppet.com/product/capabilities/code-management\">Learn more Code Management in Puppet Enterprise here.</a></p>\n</div>\n</div>\n</div>\n<div class=\"sect1\">\n<h2 id=\"setting-hiera-values\"><a class=\"anchor\" href=\"#setting-hiera-values\"></a>Setting Hiera values</h2>\n<div class=\"sectionbody\">\n<div class=\"paragraph\">\n<p>The plugin includes an experimental feature to set Hiera key/value pairs. There\nare many cases where you need to promote information through a pipeline, such\nas a build version or artifact location. Doing so is very difficult in Puppet,\nsince data promotion almost always involves changing Hiera files and committing\nto version control.</p>\n</div>\n<div class=\"paragraph\">\n<p>The plugin exposes an HTTP API endpoint that Hiera can query using the\nhiera-http backend. With the backend configured on the Puppet master(s),\nkey/value pairs can be set to scopes. A scope is arbitrary and can be anything\nyou like, such as a Puppet environment, a node&#8217;s certname, or the name of a\nFacter fact like operatingsystem or domain.</p>\n</div>\n<div class=\"paragraph\">\n<p>To set a Hiera value from a pipeline, use the <code>puppet.hiera</code> method.</p>\n</div>\n<div class=\"listingblock\">\n<div class=\"content\">\n<pre class=\"highlight nowrap\"><code class=\"language-groovy\" data-lang=\"groovy\">puppet.hiera scope: 'staging', key: 'build-version', value: env.BUILD_ID</code></pre>\n</div>\n</div>\n<div class=\"paragraph\">\n<p>Now you can set the same key with the same value to the production scope later\nin the pipeline, followed by a call to <code>puppet.job</code> to push the change out.</p>\n</div>\n</div>\n</div>\n<div class=\"sect1\">\n<h2 id=\"examples\"><a class=\"anchor\" href=\"#examples\"></a>Examples</h2>\n<div class=\"sectionbody\">\n<div class=\"paragraph\">\n<p>The\n<a href=\"https://github.com/jenkinsci/puppet-enterprise-pipeline-plugin/tree/master/examples\">plugin&#8217;s\nGithub repository</a> contains a set of example Pipeline scripts. Feel free to\nissue pull requests to add your own scripts!</p>\n</div>\n</div>\n</div>\n<div class=\"sect1\">\n<h2 id=\"whats-next\"><a class=\"anchor\" href=\"#whats-next\"></a>What&#8217;s next</h2>\n<div class=\"sectionbody\">\n<div class=\"paragraph\">\n<p>I&#8217;m pretty excited to see how this is going to help simplify continuous\ndelivery pipelines. I encourage everyone to get started with continuous\ndelivery today, even if it&#8217;s just a simple pipeline. As your practices evolve,\nyou can begin to add automated tests, automate away manual checkpoints, start\nto incorporate InfoSec tests, and include phases for practices like patch\nmanagement that require lots of manual approvals, verifications and rollouts.\nYou&#8217;ll be glad you did.</p>\n</div>\n</div>\n</div>","id":"07094990-1362-5018-bed6-12c7ddfa53ee","title":"Continuous Delivery with Jenkins and Puppet Enterprise","date":"2016-12-20T00:00:00.000Z","slug":"/blog/2016/12/20/jenkins-puppet-enterprise-plugin/","links":{"discourse":""},"authors":[{"avatar":null,"blog":null,"github":"ccaum","html":"","id":"ccaum","irc":null,"linkedin":null,"name":"Carl Caum","slug":"/blog/authors/ccaum/","twitter":"ccaum"}]}},"pageContext":{"id":"07094990-1362-5018-bed6-12c7ddfa53ee"}},
    "staticQueryHashes": ["1271460761","3649515864"]}