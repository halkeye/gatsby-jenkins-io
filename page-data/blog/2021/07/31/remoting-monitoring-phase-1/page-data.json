{
    "componentChunkName": "component---src-templates-post-js",
    "path": "/blog/2021/07/31/remoting-monitoring-phase-1/",
    "result": {"data":{"blog":{"html":"<div class=\"paragraph\">\n<p><span class=\"image\"><img src=\"/images/post-images/2021-07-31-remoting-monitoring-phase-1/opengraph.png\" alt=\"Remoting Monitoring with OpenTelemetry\"></span></p>\n</div>\n<div class=\"sect1\">\n<h2 id=\"goal\"><a class=\"anchor\" href=\"#goal\"></a>Goal</h2>\n<div class=\"sectionbody\">\n<div class=\"paragraph\">\n<p><span class=\"image\"><img src=\"/images/post-images/2021-07-31-remoting-monitoring-phase-1/goal.png\" alt=\"Goal of Remoting Monitoring with OpenTelemetry\" width=\"700\"></span></p>\n</div>\n<div class=\"paragraph\">\n<p><strong>The goal of this project:</strong></p>\n</div>\n<div class=\"ulist\">\n<ul>\n<li>\n<p>collect telemetry data(metrics, traces, logs) of remoting module with\nOpenTelemetry.</p>\n</li>\n<li>\n<p>send the telemetry data to OpenTelemetry Protocol endpoint</p>\n</li>\n</ul>\n</div>\n<div class=\"paragraph\">\n<p>Which OpenTelemetry endpoint to use and how to visualize the data are up to\nusers.</p>\n</div>\n</div>\n</div>\n<div class=\"sect1\">\n<h2 id=\"opentelemetry\"><a class=\"anchor\" href=\"#opentelemetry\"></a>OpenTelemetry</h2>\n<div class=\"sectionbody\">\n<div class=\"paragraph\">\n<p><span class=\"image\"><a class=\"image\" href=\"https://opentelemetry.io/\"><img src=\"https://cncf-branding.netlify.app/img/projects/opentelemetry/horizontal/color/opentelemetry-horizontal-color.png\" alt=\"OpenTelemetry Logo\" width=\"300\"></a></span></p>\n</div>\n<div class=\"paragraph\">\n<p><strong>An observability framework for cloud-native software</strong></p>\n</div>\n<div class=\"quoteblock\">\n<blockquote>\n<div class=\"paragraph\">\n<p>OpenTelemetry is a collection of tools, APIs, and SDKs.\nYou can use it to instrument, generate, collect, and export telemetry\ndata(metrics, logs, and traces) for analysis in order to understand your\nsoftware&#8217;s performance and behavior.</p>\n</div>\n</blockquote>\n</div>\n</div>\n</div>\n<div class=\"sect1\">\n<h2 id=\"phase-1-summary\"><a class=\"anchor\" href=\"#phase-1-summary\"></a>Phase 1 summary</h2>\n<div class=\"sectionbody\">\n<div class=\"sect2\">\n<h3 id=\"user-survey\"><a class=\"anchor\" href=\"#user-survey\"></a>User survey</h3>\n<div class=\"paragraph\">\n<p>Our team conducted a user survey to understand the pain point regarding Jenkins\nremoting.</p>\n</div>\n<div class=\"paragraph\">\n<div class=\"title\">Fig 1. What agent type/plugins do you use?</div>\n<p><span class=\"image\"><img src=\"/images/post-images/2021-07-31-remoting-monitoring-phase-1/user-survey.png\" alt=\"End user survey result\" width=\"700\"></span></p>\n</div>\n<div class=\"paragraph\">\n<p>Fig 1 shows what types of agent users use, and 17 unique respondents out of\n28 use docker for agent. So I&#8217;m planning to publish a docker image to\ndemonstrate how we can build Docker image with our monitoring feature.</p>\n</div>\n<div class=\"paragraph\">\n<p>This survey and investigation of JIRA tickets of past two years also tell me five\ncommon causes of agent unavailability.</p>\n</div>\n<div class=\"ulist\">\n<ul>\n<li>\n<p><strong>Configuration mistakes</strong></p>\n<div class=\"ulist\">\n<ul>\n<li>\n<p>Jenkins agent settings, e.g. misuse of \"tunnel connection through\" option.</p>\n</li>\n<li>\n<p>Platform settings, e.g. invalid port setting of Kubernetes' helm template.</p>\n</li>\n<li>\n<p>Network settings, e.g. Load balancer misconfiguration.</p>\n</li>\n</ul>\n</div>\n</li>\n<li>\n<p><strong>Uncontrolled shutdown of nodes</strong> for downscaling.</p>\n</li>\n<li>\n<p><strong>Timeout during provisioning</strong> a new node.</p>\n</li>\n<li>\n<p><strong>Firewall, antivirus software or other network component kill the connection</strong></p>\n</li>\n<li>\n<p><strong>Lack of hardware resources</strong>, e.g. memory, temp space, etc&#8230;&#8203;</p>\n</li>\n</ul>\n</div>\n<div class=\"paragraph\">\n<p>We also heard valuable user voice in the survey.</p>\n</div>\n<div class=\"quoteblock\">\n<div class=\"title\">What areas would you like to see better in Jenkins monitoring?</div>\n<blockquote>\n<div class=\"paragraph\">\n<p>I have created a bunch of adhoc monitoring jobs to check on the agent&#8217;s health\nand send e-mail. Would be nice to have this consolidated.</p>\n</div>\n</blockquote>\n</div>\n<div class=\"quoteblock\">\n<blockquote>\n<div class=\"paragraph\">\n<p>Having archive of nodes with the access to their logs/events would have been\nnice.</p>\n</div>\n</blockquote>\n</div>\n<div class=\"paragraph\">\n<p>I hope that implementing these feature with OpenTelemetry, which is expected to\nbecome the industry standard for observability, will bring great monitoring\nexperience to Jenkins community.</p>\n</div>\n</div>\n<div class=\"sect2\">\n<h3 id=\"proof-of-concept\"><a class=\"anchor\" href=\"#proof-of-concept\"></a>Proof of Concept</h3>\n<div class=\"sect3\">\n<h4 id=\"how-to-deliver-the-monitoring-program-to-agents\"><a class=\"anchor\" href=\"#how-to-deliver-the-monitoring-program-to-agents\"></a>How to deliver the monitoring program to agents</h4>\n<div class=\"sect4\">\n<h5 id=\"1-sending-monitoring-program-to-the-agent-over-remoting\"><a class=\"anchor\" href=\"#1-sending-monitoring-program-to-the-agent-over-remoting\"></a>1. Sending monitoring program to the agent over remoting</h5>\n<div class=\"paragraph\">\n<p><span class=\"image\"><img src=\"/images/post-images/2021-07-31-remoting-monitoring-phase-1/sending-monitoring-program-via-remoting.png\" alt=\"Sending monitoring program via remoting\"></span></p>\n</div>\n<div class=\"paragraph\">\n<p>In my first implementation, I prepared a Jenkins plugin and send the\nmonitoring program from Jenkins controller. However, this approach have\nfollowing disadvantages.</p>\n</div>\n<div class=\"olist arabic\">\n<ol class=\"arabic\">\n<li>\n<p>We cannot collect telemetry data before the initial connection.\nWe are likely to encounter a problem while provisioning a new node,\nso it&#8217;s important to observe agents' telemetry data from the beginning.</p>\n</li>\n<li>\n<p>Some agent restarters (e.g. <a href=\"https://javadoc.jenkins.io/jenkins/slaves/restarter/UnixSlaveRestarter.html\">UnixSlaveRestarter</a>)\nrestart agent completely when reconnecting. It means that the agent lost\nmonitoring program every time the connection closed, and we cannot collect\ntelemetry data after the connection is lost before a new connection is\nestablished.</p>\n</li>\n</ol>\n</div>\n<div class=\"paragraph\">\n<p>So we decided to take the next approach.</p>\n</div>\n</div>\n<div class=\"sect4\">\n<h5 id=\"2-install-monitoring-engine-when-provisioning-a-new-agent\"><a class=\"anchor\" href=\"#2-install-monitoring-engine-when-provisioning-a-new-agent\"></a>2. Install monitoring engine when provisioning a new agent</h5>\n<div class=\"paragraph\">\n<p><span class=\"image\"><img src=\"/images/post-images/2021-07-31-remoting-monitoring-phase-1/install-monitoring-engine-when-provisioning.png\" alt=\"Installing monitoring engine when provisioning\"></span></p>\n</div>\n<div class=\"paragraph\">\n<p>In this approach, user will download the monitoring program called monitoring\nengine, which is a JAR file, and place it in the agent node when provisioning.</p>\n</div>\n</div>\n</div>\n<div class=\"sect3\">\n<h4 id=\"how-to-instrument-remoting-to-produce-remoting-trace\"><a class=\"anchor\" href=\"#how-to-instrument-remoting-to-produce-remoting-trace\"></a>How to instrument remoting to produce remoting trace</h4>\n<div class=\"sect4\">\n<h5 id=\"add-instrumentation-extension-point-to-remoting\"><a class=\"anchor\" href=\"#add-instrumentation-extension-point-to-remoting\"></a>Add instrumentation extension point to remoting</h5>\n<div class=\"paragraph\">\n<p>Pull Request: <a href=\"https://github.com/jenkinsci/remoting/pull/471\" class=\"bare\">https://github.com/jenkinsci/remoting/pull/471</a></p>\n</div>\n<div class=\"paragraph\">\n<p>This approach makes the agent launch command more complicated,\nand we have to overcome this problem.</p>\n</div>\n</div>\n</div>\n</div>\n<div class=\"sect2\">\n<h3 id=\"current-state\"><a class=\"anchor\" href=\"#current-state\"></a>Current State</h3>\n<div class=\"sect3\">\n<h4 id=\"metrics\"><a class=\"anchor\" href=\"#metrics\"></a>Metrics</h4>\n<div class=\"paragraph\">\n<p>We currently support the following metrics and planning to support more.</p>\n</div>\n<table class=\"tableblock frame-all grid-all stretch\">\n<colgroup>\n<col style=\"width: 13.3333%;\">\n<col style=\"width: 6.6666%;\">\n<col style=\"width: 6.6666%;\">\n<col style=\"width: 20%;\">\n<col style=\"width: 53.3335%;\">\n</colgroup>\n<tbody>\n<tr>\n<td class=\"tableblock halign-left valign-top\"><p class=\"tableblock\">metrics</p></td>\n<td class=\"tableblock halign-left valign-top\"><p class=\"tableblock\">unit</p></td>\n<td class=\"tableblock halign-left valign-top\"><p class=\"tableblock\">label</p></td>\n<td class=\"tableblock halign-left valign-top\"><p class=\"tableblock\">key</p></td>\n<td class=\"tableblock halign-left valign-top\"><p class=\"tableblock\">description</p></td>\n</tr>\n<tr>\n<td class=\"tableblock halign-left valign-top\"><p class=\"tableblock\">system.cpu.load</p></td>\n<td class=\"tableblock halign-left valign-top\"><p class=\"tableblock\">1</p></td>\n<td class=\"tableblock halign-left valign-top\"></td>\n<td class=\"tableblock halign-left valign-top\"></td>\n<td class=\"tableblock halign-left valign-top\"><p class=\"tableblock\">System CPU load. See <code>com.sun.management.OperatingSystemMXBean.getSystemCpuLoad</code></p></td>\n</tr>\n<tr>\n<td class=\"tableblock halign-left valign-top\"><p class=\"tableblock\">system.cpu.load.average.1m</p></td>\n<td class=\"tableblock halign-left valign-top\"></td>\n<td class=\"tableblock halign-left valign-top\"></td>\n<td class=\"tableblock halign-left valign-top\"></td>\n<td class=\"tableblock halign-left valign-top\"><p class=\"tableblock\">System CPU load average 1 minute See <code>java.lang.management.OperatingSystemMXBean.getSystemLoadAverage</code></p></td>\n</tr>\n<tr>\n<td class=\"tableblock halign-left valign-top\"><p class=\"tableblock\">system.memory.usage</p></td>\n<td class=\"tableblock halign-left valign-top\"><p class=\"tableblock\">bytes</p></td>\n<td class=\"tableblock halign-left valign-top\"><p class=\"tableblock\">state</p></td>\n<td class=\"tableblock halign-left valign-top\"><p class=\"tableblock\"><code>used</code>, <code>free</code></p></td>\n<td class=\"tableblock halign-left valign-top\"><p class=\"tableblock\">see <code>com.sun.management.OperatingSystemMXBean.getTotalPhysicalMemorySize</code>\nand <code>com.sun.management.OperatingSystemMXBean.getFreePhysicalMemorySize</code></p></td>\n</tr>\n<tr>\n<td class=\"tableblock halign-left valign-top\"><p class=\"tableblock\">system.memory.utilization</p></td>\n<td class=\"tableblock halign-left valign-top\"><p class=\"tableblock\">1</p></td>\n<td class=\"tableblock halign-left valign-top\"></td>\n<td class=\"tableblock halign-left valign-top\"></td>\n<td class=\"tableblock halign-left valign-top\"><p class=\"tableblock\">System memory utilization,\nsee <code>com.sun.management.OperatingSystemMXBean.getTotalPhysicalMemorySize</code>\nand <code>com.sun.management.OperatingSystemMXBean.getFreePhysicalMemorySize</code>.\nReport 0% if no physical memory is discovered by the JVM.</p></td>\n</tr>\n<tr>\n<td class=\"tableblock halign-left valign-top\"><p class=\"tableblock\">system.paging.usage</p></td>\n<td class=\"tableblock halign-left valign-top\"><p class=\"tableblock\">bytes</p></td>\n<td class=\"tableblock halign-left valign-top\"><p class=\"tableblock\">state</p></td>\n<td class=\"tableblock halign-left valign-top\"><p class=\"tableblock\"><code>used</code>, <code>free</code></p></td>\n<td class=\"tableblock halign-left valign-top\"><p class=\"tableblock\">see <code>com.sun.management.OperatingSystemMXBean.getFreeSwapSpaceSize</code>\nand <code>com.sun.management.OperatingSystemMXBean.getTotalSwapSpaceSize</code>.</p></td>\n</tr>\n<tr>\n<td class=\"tableblock halign-left valign-top\"><p class=\"tableblock\">system.paging.utilization</p></td>\n<td class=\"tableblock halign-left valign-top\"><p class=\"tableblock\">1</p></td>\n<td class=\"tableblock halign-left valign-top\"></td>\n<td class=\"tableblock halign-left valign-top\"></td>\n<td class=\"tableblock halign-left valign-top\"><p class=\"tableblock\">see <code>com.sun.management.OperatingSystemMXBean.getFreeSwapSpaceSize</code>\nand <code>com.sun.management.OperatingSystemMXBean.getTotalSwapSpaceSize</code>.\nReport 0% if no swap memory is discovered by the JVM.</p></td>\n</tr>\n<tr>\n<td class=\"tableblock halign-left valign-top\"><p class=\"tableblock\">process.cpu.load</p></td>\n<td class=\"tableblock halign-left valign-top\"><p class=\"tableblock\">%</p></td>\n<td class=\"tableblock halign-left valign-top\"></td>\n<td class=\"tableblock halign-left valign-top\"></td>\n<td class=\"tableblock halign-left valign-top\"><p class=\"tableblock\">Process CPU load. See <code>com.sun.management.OperatingSystemMXBean.getProcessCpuLoad</code>.</p></td>\n</tr>\n<tr>\n<td class=\"tableblock halign-left valign-top\"><p class=\"tableblock\">process.cpu.time</p></td>\n<td class=\"tableblock halign-left valign-top\"><p class=\"tableblock\">ns</p></td>\n<td class=\"tableblock halign-left valign-top\"></td>\n<td class=\"tableblock halign-left valign-top\"></td>\n<td class=\"tableblock halign-left valign-top\"><p class=\"tableblock\">Process CPU time. See <code>com.sun.management.OperatingSystemMXBean.getProcessCpuTime</code>.</p></td>\n</tr>\n<tr>\n<td class=\"tableblock halign-left valign-top\" rowspan=\"2\"><p class=\"tableblock\">runtime.jvm.memory.area</p></td>\n<td class=\"tableblock halign-left valign-top\" rowspan=\"2\"><p class=\"tableblock\">bytes</p></td>\n<td class=\"tableblock halign-left valign-top\"><p class=\"tableblock\">type</p></td>\n<td class=\"tableblock halign-left valign-top\"><p class=\"tableblock\"><code>used</code>, <code>committed</code>, <code>max</code></p></td>\n<td class=\"tableblock halign-left valign-top\" rowspan=\"2\"><p class=\"tableblock\">see <a href=\"https://docs.oracle.com/en/java/javase/11/docs/api/java.management/java/lang/management/MemoryUsage.html\">MemoryUsage</a></p></td>\n</tr>\n<tr>\n<td class=\"tableblock halign-left valign-top\"><p class=\"tableblock\">area</p></td>\n<td class=\"tableblock halign-left valign-top\"><p class=\"tableblock\"><code>heap</code>, <code>non_heap</code></p></td>\n</tr>\n<tr>\n<td class=\"tableblock halign-left valign-top\" rowspan=\"2\"><p class=\"tableblock\">runtime.jvm.memory.pool</p></td>\n<td class=\"tableblock halign-left valign-top\" rowspan=\"2\"><p class=\"tableblock\">bytes</p></td>\n<td class=\"tableblock halign-left valign-top\"><p class=\"tableblock\">type</p></td>\n<td class=\"tableblock halign-left valign-top\"><p class=\"tableblock\"><code>used</code>, <code>committed</code>, <code>max</code></p></td>\n<td class=\"tableblock halign-left valign-top\" rowspan=\"2\"><p class=\"tableblock\">see <a href=\"https://docs.oracle.com/en/java/javase/11/docs/api/java.management/java/lang/management/MemoryUsage.html\">MemoryUsage</a></p></td>\n</tr>\n<tr>\n<td class=\"tableblock halign-left valign-top\"><p class=\"tableblock\">pool</p></td>\n<td class=\"tableblock halign-left valign-top\"><p class=\"tableblock\"><code>PS Eden Space</code>, <code>G1 Old Gen</code>&#8230;&#8203;</p></td>\n</tr>\n<tr>\n<td class=\"tableblock halign-left valign-top\"><p class=\"tableblock\">runtime.jvm.gc.time</p></td>\n<td class=\"tableblock halign-left valign-top\"><p class=\"tableblock\">ms</p></td>\n<td class=\"tableblock halign-left valign-top\"><p class=\"tableblock\">gc</p></td>\n<td class=\"tableblock halign-left valign-top\"><p class=\"tableblock\"><code>G1 Young Generation</code>, <code>G1 Old Generation</code>, &#8230;&#8203;</p></td>\n<td class=\"tableblock halign-left valign-top\"><p class=\"tableblock\">see <a href=\"https://docs.oracle.com/en/java/javase/11/docs/api/jdk.management/com/sun/management/GarbageCollectorMXBean.html\">GarbageCollectorMXBean</a></p></td>\n</tr>\n<tr>\n<td class=\"tableblock halign-left valign-top\"><p class=\"tableblock\">runtime.jvm.gc.count</p></td>\n<td class=\"tableblock halign-left valign-top\"><p class=\"tableblock\">1</p></td>\n<td class=\"tableblock halign-left valign-top\"><p class=\"tableblock\">gc</p></td>\n<td class=\"tableblock halign-left valign-top\"><p class=\"tableblock\"><code>G1 Young Generation</code>, <code>G1 Old Generation</code>, &#8230;&#8203;</p></td>\n<td class=\"tableblock halign-left valign-top\"><p class=\"tableblock\">see <a href=\"https://docs.oracle.com/en/java/javase/11/docs/api/jdk.management/com/sun/management/GarbageCollectorMXBean.html\">GarbageCollectorMXBean</a></p></td>\n</tr>\n</tbody>\n</table>\n</div>\n<div class=\"sect3\">\n<h4 id=\"traces\"><a class=\"anchor\" href=\"#traces\"></a>Traces</h4>\n<div class=\"paragraph\">\n<p>We tried several approaches to instrument remoting module, but good approach is not established yet.</p>\n</div>\n<div class=\"paragraph\">\n<p>Here is a draft documentation of the spans to collect. <a href=\"https://docs.google.com/document/d/1gjRamLWz3NwenVifC5pYyBMmxsUjl9MjspZF0mRYeaI/edit#heading=h.6xn68iwvd7gz\">Google Doc</a></p>\n</div>\n</div>\n<div class=\"sect3\">\n<h4 id=\"logs\"><a class=\"anchor\" href=\"#logs\"></a>Logs</h4>\n<div class=\"paragraph\">\n<p>Coming soon!</p>\n</div>\n</div>\n</div>\n<div class=\"sect2\">\n<h3 id=\"metric-and-span-demo-visualization\"><a class=\"anchor\" href=\"#metric-and-span-demo-visualization\"></a>Metric and span demo visualization</h3>\n<div class=\"paragraph\">\n<p>Our team created a demo example with Docker compose and visualized the metrics and spans.</p>\n</div>\n<div class=\"paragraph\">\n<p><strong><em>Click to open in new tab</em></strong></p>\n</div>\n<div class=\"paragraph\">\n<p><span class=\"image\"><a class=\"image\" href=\"/images/post-images/2021-07-31-remoting-monitoring-phase-1/prometheus-metrics.png\" target=\"_blank\" rel=\"noopener\"><img src=\"/images/post-images/2021-07-31-remoting-monitoring-phase-1/prometheus-metrics.png\" alt=\"prometheus metric visualization\" width=\"40%\"></a></span>\n<span class=\"image\"><a class=\"image\" href=\"/images/post-images/2021-07-31-remoting-monitoring-phase-1/jaeger-spans.png\" target=\"_blank\" rel=\"noopener\"><img src=\"/images/post-images/2021-07-31-remoting-monitoring-phase-1/jaeger-spans.png\" alt=\"jaeger span visualization\" width=\"55%\"></a></span></p>\n</div>\n</div>\n</div>\n</div>\n<div class=\"sect1\">\n<h2 id=\"google-summer-of-code-midterm-demo\"><a class=\"anchor\" href=\"#google-summer-of-code-midterm-demo\"></a>Google Summer of Code Midterm Demo</h2>\n<div class=\"sectionbody\">\n<div class=\"videoblock\">\n<div class=\"title\">Our project demo starts with 8:20</div>\n<div class=\"content\">\n<iframe width=\"400\" height=\"300\" src=\"https://www.youtube.com/embed/_D0hiA1Cgz8?rel=0&amp;start=514\" frameborder=\"0\" allowfullscreen></iframe>\n</div>\n</div>\n</div>\n</div>\n<div class=\"sect1\">\n<h2 id=\"next-step\"><a class=\"anchor\" href=\"#next-step\"></a>Next Step</h2>\n<div class=\"sectionbody\">\n<div class=\"ulist\">\n<ul>\n<li>\n<p>Log support</p>\n</li>\n<li>\n<p>Alpha release!</p>\n</li>\n</ul>\n</div>\n</div>\n</div>","id":"eb573050-2c0c-527f-ab2c-3da89d375c1d","title":"Remoting Monitoring with OpenTelemetry - Coding Phase 1","date":"2021-07-31T00:00:00.000Z","slug":"/blog/2021/07/31/remoting-monitoring-phase-1/","links":{"discourse":""},"authors":[{"avatar":{"childImageSharp":null},"blog":null,"github":"Aki-7","html":"<div class=\"paragraph\">\n<p>GSoC 2021 student (Jenkins Remoting Monitoring). Akihiro is a student in the Department of information and communication engineering at the University of Tokyo.</p>\n</div>","id":"aki-7","irc":null,"linkedin":null,"name":"Akihiro Kiuchi","slug":"/blog/author/aki-7","twitter":null}]}},"pageContext":{"next":"/blog/2021/08/02/cloudevents-plugin-phase-I/","previous":"/blog/2021/07/30/introducing-conventional-commits-plugin-for-jenkins/","id":"eb573050-2c0c-527f-ab2c-3da89d375c1d"}},
    "staticQueryHashes": ["1271460761","3649515864"]}