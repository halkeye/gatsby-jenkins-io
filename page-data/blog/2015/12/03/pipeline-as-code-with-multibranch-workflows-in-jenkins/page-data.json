{
    "componentChunkName": "component---src-templates-post-js",
    "path": "/blog/2015/12/03/pipeline-as-code-with-multibranch-workflows-in-jenkins/",
    "result": {"data":{"blog":{"html":"<div class=\"paragraph\">\n<p><em>Note: This is a guest post by <a href=\"https://github.com/kishorebhatia\">Kishore Bhatia</a>. <a href=\"https://twitter.com/BhatiaKishore\">Kishore</a> works for <a href=\"https://www.cloudbees.com\">CloudBees</a>, building custom frameworks with Open Source software and helping customers solve engineering problems around continuous delivery and DevOps at scale.</em></p>\n</div>\n<hr>\n<div class=\"paragraph\">\n<p>This year some great new Jenkins features came out of the butler&#8217;s goodie bag - amongst them, the most important one being the ability to realize <a href=\"https://www.voxxed.com/blog/2015/06/kohsuke-kawaguchi-the-main-challenge-for-jenkins-is-with-itself/\">continuous delivery pipeline as code</a>!\nThe features like Workflow Multibranch, pipeline-as-code (with a marker file that Jenkins looks for in your application&#8217;s SCM repository/branch, aptly named Jenkinsfile) are the foundations to making Jenkins super intelligent to automagically create workflows (rather, a CI/CD pipeline) to build your code and orchestrate the work required to drive your application from concept to delivery!</p>\n</div>\n<div class=\"sect2\">\n<h3 id=\"overview\"><a class=\"anchor\" href=\"#overview\"></a>Overview</h3>\n<div class=\"paragraph\">\n<p>The Workflow Multibranch feature (provided by the <a href=\"https://github.com/jenkinsci/workflow-plugin\">workflow plugin</a>) provides the following key abilities:</p>\n</div>\n<div class=\"ulist\">\n<ul>\n<li>\n<p>Automatic Workflow (job) creation in Jenkins per new branch in the repo (assuming webhooks are registered from GH to Jenkins).</p>\n</li>\n<li>\n<p>Build specific to that child-branch and its unique scm change and build history.</p>\n</li>\n<li>\n<p>Automatic job pruning/deletion for branches deleted from the repository, according to the settings.</p>\n</li>\n<li>\n<p>Flexibility to individually configure branch properties, by overriding the parent properties, if required.</p>\n</li>\n</ul>\n</div>\n<div class=\"paragraph\">\n<p>Jenkins pipeline-as-code (concept) enables you to maintain your CI/CD workflow logic in the project/application source code repo with no additional configuration to be maintained per branch in Jenkins.</p>\n</div>\n<div class=\"paragraph\">\n<p>The Workflow script to build/test/deploy your code is always synchronized with the rest of the source code you are working on.</p>\n</div>\n<div class=\"paragraph\">\n<p><strong>To demonstrate the concept here</strong> - Let&#8217;s use a basic Java Web application project with a Maven pom.xml as shown in the structure below (this is using GitHub as the SCM but you can do this on SVN or Mercurial too).</p>\n</div>\n<div class=\"paragraph\">\n<p><a href=\"https://github.com/kishorebhatia/pipeline-as-code-demo\">This project</a> has a marker file for Jenkins in the repo - <code>Jenkinsfile</code>.<center>image:https://web.archive.org/web/*/https://agentdero.cachefly.net/continuousblog/pipeline-as-code-guest-blog/Pic1.png</center></p>\n</div>\n<div class=\"paragraph\">\n<p><strong>So, what&#8217;s a Jenkinsfile?</strong> The <a href=\"https://github.com/kishorebhatia/pipeline-as-code-demo/blob/master/Jenkinsfile\">Jenkinsfile</a> is essentially your Jenkins Workflow, a script, that defines the CI/CD pipeline logic for a project with steps to build/test/deploy etc. captured in various stages.</p>\n</div>\n<div class=\"paragraph\">\n<p>So for our sample Java web application, a basic Jenkinsfile could be something like -</p>\n</div>\n<div class=\"literalblock\">\n<div class=\"content\">\n<pre class=\"nowrap\">node {\n   // Mark the code checkout 'stage'....\n   stage 'Checkout'\n\n   // Checkout code from repository\n   checkout scm\n\n   // Get the maven tool.\n   // ** NOTE: This 'M3' maven tool must be configured\n   // **       in the global configuration.\n   def mvnHome = tool 'M3'\n\n   // Mark the code build 'stage'....\n   stage 'Build'\n   // Run the maven build\n   sh \"${mvnHome}/bin/mvn clean install\"\n}</pre>\n</div>\n</div>\n<div class=\"paragraph\">\n<p>Just having this file in the source code repo root would mean that -</p>\n</div>\n<div class=\"ulist\">\n<ul>\n<li>\n<p>Jenkins will automatically recognize this branch and create appropriate jobs by itself.</p>\n</li>\n<li>\n<p>Quick, 1-step code checkout using: &#8220;checkout scm&#8221; in your workflow</p>\n</li>\n<li>\n<p>Every time a new change is pushed to this branch, the branch is built and the commit status gets updated.</p>\n</li>\n<li>\n<p>When the branch is destroyed in the repository, or if Jenkinsfile is removed, the corresponding job gets destroyed from Jenkins automatically (<em>You can retain these jobs and/or archive the builds for audit/compliance requirements using the retention property - Orphan Item strategy</em>)</p>\n</li>\n</ul>\n</div>\n<div class=\"admonitionblock note\">\n<table>\n<tr>\n<td class=\"icon\">\n<i class=\"fa icon-note\" title=\"Note\"></i>\n</td>\n<td class=\"content\">\nthere are various mechanisms to promote reuse of Workflow scripts, such as the <a href=\"https://github.com/jenkinsci/workflow-cps-global-lib-plugin\">Workflow Global Library</a>.\n</td>\n</tr>\n</table>\n</div>\n</div>\n<div class=\"sect2\">\n<h3 id=\"required-jenkins-configuration\"><a class=\"anchor\" href=\"#required-jenkins-configuration\"></a>Required Jenkins configuration</h3>\n<div class=\"paragraph\">\n<p>Make sure you&#8217;ve the latest <a href=\"https://github.com/jenkinsci/workflow-plugin\">Workflow</a> and (v1.11 as of writing this blog) Workflow Multibranch plugins installed on your Jenkins instance<center>image:https://web.archive.org/web/*/https://agentdero.cachefly.net/continuousblog/pipeline-as-code-guest-blog/Pic2.png</center></p>\n</div>\n<div class=\"paragraph\">\n<p>Also, ensure that other dependencies, like SCM plugins and build tools, are met:</p>\n</div>\n<div class=\"ulist\">\n<ul>\n<li>\n<p>Either SVN/Git/Mercurial (depending on your SCM)</p>\n</li>\n<li>\n<p>GitHub Branch Source Plugin (optimized to use the GitHub API and improve performance)</p>\n</li>\n<li>\n<p>Maven build tool</p>\n</li>\n</ul>\n</div>\n<div class=\"paragraph\">\n<p>Finally, make sure you&#8217;ve created the required Webhook from your SCM (Github in this case) to Jenkins.\nHere&#8217;s how to do that:</p>\n</div>\n<div class=\"ulist\">\n<ul>\n<li>\n<p><a href=\"https://thepracticalsysadmin.com/setting-up-a-github-webhook-in-jenkins/\">Setting up GitHub Webhooks in Jenkins</a></p>\n</li>\n<li>\n<p><a href=\"https://gist.github.com/misterbrownlee/3708738\">Step-by-step guide to setting up Jenkins for GitHub projects</a></p>\n</li>\n</ul>\n</div>\n<div class=\"paragraph\">\n<p>Then create a new <em>Multibranch Workflow</em> Job with configuration as shown below - mainly selecting the Branch Sources (Git, in this example) and providing the branch/repo URL with credentials.</p>\n</div>\n<div class=\"paragraph\">\n<p><em>Branch sources</em> (Git) - <code>https://github.com/kishorebhatia/pipeline-as-code-demo</code> (or a repo where you&#8217;ve cloned this source code with Jenkinsfile)</p>\n</div>\n<div class=\"paragraph\">\n<p>Leave all other properties default and <em>Save</em>.<center>image:https://web.archive.org/web/*/https://agentdero.cachefly.net/continuousblog/pipeline-as-code-guest-blog/Pic3.png</center></p>\n</div>\n<div class=\"paragraph\">\n<p>You&#8217;ll observe that Jenkins would perform Branch Indexing on that &#8220;cd&#8221; job folder and start the workflow for the master branch, with an automatically created new job, named master, under the &#8220;cd&#8221; folder.</p>\n</div>\n<div class=\"paragraph\">\n<p>The workflow does a dummy step for application deploys to the environments in this sequence <em>Staging</em> -&gt; Waits for manual approval -&gt; <em>PROD</em></p>\n</div>\n<div class=\"paragraph\">\n<p>Now, let&#8217;s create a new branch off of this master branch in your cloned git repo:</p>\n</div>\n<div class=\"ulist\">\n<ul>\n<li>\n<p><code>$ git branch newBranch</code> (create a newBranch)</p>\n</li>\n<li>\n<p><code>$ git checkout newBranch</code> (switches to newBranch)</p>\n</li>\n<li>\n<p><code>$ git push --set-upstream origin newBranch</code> (pushes newBranch)</p>\n</li>\n</ul>\n</div>\n<div class=\"paragraph\">\n<p>You&#8217;ll observe that your Jenkins instance automatically picks up this newBranch and starts running the workflow (with the Jenkinsfile in this newBranch) to build/test/deploy the code.<center>image:https://web.archive.org/web/*/https://agentdero.cachefly.net/continuousblog/pipeline-as-code-guest-blog/Pic4.png</center></p>\n</div>\n<div class=\"paragraph\">\n<p>Next, if you now delete this <code>newBranch</code> (<code>git branch -D newBranch</code>), Jenkins will automatically remove the orphan Workflow job for <code>newBranch</code>. You can retain these jobs even after the branches are deleted using the <em>Orphaned Item Strategy</em> property in the main \"cd\" job&#8217;s configuration.</p>\n</div>\n<div class=\"paragraph\">\n<p>So we observed the following benefits of this pipeline-as-code approach:</p>\n</div>\n<div class=\"ulist\">\n<ul>\n<li>\n<p>Overall job definition is a script (Jenkinsfile)</p>\n</li>\n<li>\n<p>Calls your build tools and scripts for details</p>\n</li>\n<li>\n<p>The build script can be versioned alongside project sources</p>\n</li>\n<li>\n<p>Jenkins handles feature/experimental branches automatically</p>\n</li>\n<li>\n<p>Keep less configuration in <code>$JENKINS_HOME</code></p>\n</li>\n</ul>\n</div>\n</div>\n<div class=\"sect2\">\n<h3 id=\"dockerized-demo-environment\"><a class=\"anchor\" href=\"#dockerized-demo-environment\"></a>Dockerized Demo environment</h3>\n<div class=\"paragraph\">\n<p>You can also use the following docker image to run this demo with a preconfigured Jenkins environment and the sample job: <code>jenkinsci/workflow-demo</code> (i.e. <code>docker pull jenkinsci/workflow-demo</code>)</p>\n</div>\n<div class=\"paragraph\">\n<p>This docker container includes Jenkins with Workflow and Workflow Multibranch plugins, a local git repo with the aforementioned Java web application and Jetty to demonstrate a continuous delivery pipeline of this application deployed and tested across multiple environments in the pipeline with an approval gate before promoting to PROD (like QA, Staging and PROD).</p>\n</div>\n<div class=\"paragraph\">\n<p>There&#8217;s a \"cd\" job pre-configured as a multibranch Workflow job.</p>\n</div>\n<div class=\"paragraph\">\n<p>Launch the docker demo as: <code>docker run -p 8080:8080 -p 8081:8081 -p 9418:9418 -ti jenkinsci/workflow-demo</code></p>\n</div>\n<div class=\"paragraph\">\n<p>Now, you can access Jenkins on port 8080 and Jetty on port 8081 from localhost or the IP of your boot2docker/docker-machine environment.</p>\n</div>\n<div class=\"paragraph\">\n<p>The demo container has a local git repo so you can clone: <code>git://localhost/repo</code>. When creating new branches, each branch automatically creates a matching subproject in Jenkins and triggers the build for that branch. The workflow:</p>\n</div>\n<div class=\"ulist\">\n<ul>\n<li>\n<p>Checks out source code from the same repository and commit as <code>Jenkinsfile</code>.</p>\n</li>\n<li>\n<p>Builds sources via Maven with unit testing.</p>\n</li>\n<li>\n<p>Runs two parallel integration tests that involve deploying the app to ephemeral server instances, which get thrown away when tests are done (this is done by using auto-deployment of Jetty)</p>\n</li>\n<li>\n<p>Once integration tests are successful, the webapp gets to the staging server at <a href=\"http://localhost:8081/staging/\">localhost:8081/staging</a> (or your docker-machine/boot2docker instance IP)</p>\n</li>\n<li>\n<p>requires a human to Manually inspect the staging instance, and when ready, approves the deployment to the production server at <a href=\"http://localhost:8081/production/\" class=\"bare\">http://localhost:8081/production/</a></p>\n</li>\n</ul>\n</div>\n</div>\n<div class=\"sect2\">\n<h3 id=\"references\"><a class=\"anchor\" href=\"#references\"></a>References</h3>\n<div class=\"ulist\">\n<ul>\n<li>\n<p><a href=\"https://developer-blog.cloudbees.com/2015/08/workflow-19-and-multibranch-beta.html\">Developer blog by jglick introducing multibranch support</a></p>\n</li>\n<li>\n<p><a href=\"https://github.com/jenkinsci/workflow-plugin/blob/master/TUTORIAL.md\">workflow plugin tutorial</a></p>\n</li>\n<li>\n<p><a href=\"https://github.com/jenkinsci/workflow-plugin#presentations\">workflow plugin presentations</a></p>\n</li>\n<li>\n<p><a href=\"https://github.com/jenkinsci/workflow-aggregator-plugin/tree/master/demo\">workflow plugin demo readme</a></p>\n</li>\n</ul>\n</div>\n</div>","id":"51e550d9-2ab9-5be8-be79-96bef6d8ca1a","title":"Pipeline-as-code with Multibranch Workflows in Jenkins","date":"2015-12-03T00:00:00.000Z","slug":"/blog/2015/12/03/pipeline-as-code-with-multibranch-workflows-in-jenkins/","links":{"discourse":""},"authors":[{"avatar":{"childImageSharp":null},"blog":"http://unethicalblogger.com","github":"rtyler","html":"<div class=\"paragraph\">\n<p>R&#46; Tyler Croy has been part of the Jenkins project for the past seven years.\nWhile avoiding contributing any Java code, Tyler is involved in many of the\nother aspects of the project which keep it running, such as this website,\ninfrastructure, governance, etc.</p>\n</div>","id":"rtyler","irc":null,"linkedin":null,"name":"R. Tyler Croy","slug":"/blog/author/rtyler","twitter":"agentdero"}]}},"pageContext":{"next":"/blog/2015/12/09/security-updates-released-today/","previous":"/blog/2015/12/02/hacksgiving-left-overs/","id":"51e550d9-2ab9-5be8-be79-96bef6d8ca1a"}},
    "staticQueryHashes": ["1271460761","3649515864"]}