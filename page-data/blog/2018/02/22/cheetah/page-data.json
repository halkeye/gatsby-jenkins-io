{
    "componentChunkName": "component---src-templates-post-js",
    "path": "/blog/2018/02/22/cheetah/",
    "result": {"data":{"blog":{"html":"<div id=\"toc\" class=\"toc\">\n<div id=\"toctitle\">Table of Contents</div>\n<ul class=\"sectlevel1\">\n<li><a href=\"#introducing-project-cheetah\">Introducing \"Project Cheetah\"</a></li>\n<li><a href=\"#yes-but-what-does-it-do\">Yes, but what does it DO?</a></li>\n<li><a href=\"#how-do-i-set-speeddurability-settings\">How Do I Set Speed/Durability Settings?</a>\n<ul class=\"sectlevel2\">\n<li><a href=\"#1-globally-you-can-choose-a-global-default-durability-setting\">1. <strong>Globally</strong>, you can choose a global default durability setting:</a></li>\n<li><a href=\"#2-each-pipeline-can-get-a-custom-durability-setting\">2. <strong>Each Pipeline</strong> can get a custom Durability Setting:</a></li>\n<li><a href=\"#3-multibranch-projects-can-use-a-new-branchproperty-to-customize-the-durability-setting\">3. <strong>Multibranch Projects</strong> can use a new BranchProperty to customize the Durability Setting.</a></li>\n</ul>\n</li>\n<li><a href=\"#will-performance-optimized-mode-help-me\">Will Performance-Optimized Mode Help Me?</a></li>\n<li><a href=\"#other-goodies\">Other Goodies</a></li>\n<li><a href=\"#how-did-you-do-it\">How Did You Do It?</a></li>\n<li><a href=\"#what-next\">What Next?</a></li>\n</ul>\n</div>\n<div class=\"paragraph\">\n<p>Since it launched, Pipeline has had a bit of a Dr. Jekyll and Mr. Hyde performance problem.  In certain circumstances, Pipeline can turn from a mild-mannered CI/CD assistant into a monster.  It will happily eat storage read/write capacity like popcorn without caring about the other concerns of our friendly butler.  When combined with other additional factors, this can result in real-world stability problems.  For example, combining slow storage with a spike in running Pipelines has brought down production Jenkins at more than one organization.  Similarly, users see issues if a busy controller gets hit with an extra source of stress; past culprits have been heavy automated (ab)use of Jenkins APIs, now-solved user lookup bugs, backup jobs, and plugins run crazy that load excessive numbers of builds.  Symptoms ranged from visible slowdowns in the UI to unresponsive jobs and \"hung\" controllers.</p>\n</div>\n<div class=\"paragraph\">\n<p>Now I&#8217;m <em>not</em> saying this to scare people or to criticize the technology we&#8217;ve built. Implementing <a href=\"/blog/2017/02/01/pipeline-scalability-best-practice/\">Pipeline scalability best practices</a> coupled with SSD storage keeps Jenkins in a happy place.  We just need context on the weaknesses to see why it&#8217;s important to address them.</p>\n</div>\n<div class=\"sect1\">\n<h2 id=\"introducing-project-cheetah\"><a class=\"anchor\" href=\"#introducing-project-cheetah\"></a>Introducing \"Project Cheetah\"</h2>\n<div class=\"sectionbody\">\n<div class=\"paragraph\">\n<p>Today we&#8217;re announcing the first major results of \"Project Cheetah\", our long-running effort to address these challenges and improve Pipeline scalability.  More broadly, Cheetah aims to help in 3 places:</p>\n</div>\n<div class=\"ulist\">\n<ul>\n<li>\n<p><strong>Small-scale containers:</strong> Pipeline needs to run leanly in resource-constrained containers, to enable easy scale-out without consuming excessive resources on shared container hosts.</p>\n</li>\n<li>\n<p><strong>Enterprise systems:</strong> Pipeline needs to effectively serve high-scale Jenkins instances that are central to many large companies.</p>\n</li>\n<li>\n<p><strong>General case:</strong> run Pipelines a bit more quickly on average, and allow users to get much-stronger performance in worst-case scenarios.</p>\n</li>\n</ul>\n</div>\n<div class=\"paragraph\">\n<p>These changes are implemented across many of the Pipeline plugins.</p>\n</div>\n</div>\n</div>\n<div class=\"sect1\">\n<h2 id=\"yes-but-what-does-it-do\"><a class=\"anchor\" href=\"#yes-but-what-does-it-do\"></a>Yes, but what does it DO?</h2>\n<div class=\"sectionbody\">\n<div class=\"paragraph\">\n<p>Project Cheetah offers several things, but the most important is Durability Settings for all Pipelines, and especially the Performance-Optimized setting.  This setting avoids several potentially unexpected performance \"surprises\" that may strike users.  In the general case, it greatly reduces the disk IO needs for Pipeline.  How much?  Below is a graph of storage utilization with legacy Pipeline versions (think early 2017) and with the latest version using the Performance-Optimized mode.  These are tested on an AWS instance backed by an EBS volume provisioned with 300 IOPs.</p>\n</div>\n<div class=\"paragraph\">\n<p>Before and After:</p>\n</div>\n<div class=\"paragraph\">\n<p><span class=\"image center\"><img src=\"/images/post-images/2018-02-22-cheetah/io-utilization.png\" alt=\"io utilization\"></span></p>\n</div>\n<div class=\"paragraph\">\n<p>As you can see, storage utilization goes down by a <em>lot</em>.  While the exact number will vary, across the benchmark testcases <strong>this results in Pipeline throughput of 2x to 6x the previous before becoming IO-bound</strong>. This also increases stability of Jenkins controllers because they will tolerate unexpected load.</p>\n</div>\n<div class=\"paragraph\">\n<p>This comes with a major drop in CPU IOWait as well:</p>\n</div>\n<div class=\"paragraph\">\n<p><span class=\"image center\"><img src=\"/images/post-images/2018-02-22-cheetah/cpu-iowait.png\" alt=\"cpu iowait\"></span></p>\n</div>\n<div class=\"paragraph\">\n<p>And of course the rate at which data is written to disk and number of writes/s is also reduced:</p>\n</div>\n<div class=\"paragraph\">\n<p><span class=\"image center\"><img src=\"/images/post-images/2018-02-22-cheetah/diskio.png\" alt=\"diskio\"></span></p>\n</div>\n<div class=\"paragraph\">\n<p>For enterprise users, timing stats often show 10-20% of normal builds is serializing the Program and writing the record of steps run (\"FlowNodes\") - the performance optimized durability setting will cut this to <em>almost nothing</em> (for standard pipelines, 1/100 or less) - so builds will complete faster, especially complex ones.</p>\n</div>\n<div class=\"paragraph\">\n<p>Please see the <a href=\"/doc/book/pipeline/scaling-pipeline/\">Pipeline Scalability documentation</a> for deeper information on the new Durability Settings, how to use them, and which plugin versions are required to gain these features.</p>\n</div>\n<div class=\"paragraph\">\n<p>Also, users may see a reduction in hung Pipelines because new test utilities made it possible to identify and correct a variety of bugs.</p>\n</div>\n</div>\n</div>\n<div class=\"sect1\">\n<h2 id=\"how-do-i-set-speeddurability-settings\"><a class=\"anchor\" href=\"#how-do-i-set-speeddurability-settings\"></a>How Do I Set Speed/Durability Settings?</h2>\n<div class=\"sectionbody\">\n<div class=\"paragraph\">\n<p>There are 3 ways to configure the durability setting:</p>\n</div>\n<div class=\"sect2\">\n<h3 id=\"1-globally-you-can-choose-a-global-default-durability-setting\"><a class=\"anchor\" href=\"#1-globally-you-can-choose-a-global-default-durability-setting\"></a>1. <strong>Globally</strong>, you can choose a global default durability setting:</h3>\n<div class=\"paragraph\">\n<p>Under \"Manage Jenkins\" &gt; \"Configure System\", labelled \"Pipeline Speed/Durability Settings\".  You can override these with the more specific settings below.</p>\n</div>\n<div class=\"paragraph\">\n<p><span class=\"image center\"><img src=\"/images/post-images/2018-02-22-cheetah/global-durability.png\" alt=\"global durability\"></span></p>\n</div>\n</div>\n<div class=\"sect2\">\n<h3 id=\"2-each-pipeline-can-get-a-custom-durability-setting\"><a class=\"anchor\" href=\"#2-each-pipeline-can-get-a-custom-durability-setting\"></a>2. <strong>Each Pipeline</strong> can get a custom Durability Setting:</h3>\n<div class=\"paragraph\">\n<p>This is one of the job properties located at the top of the job configuration, labelled \"Custom Pipeline Speed/Durability Level.\"  <strong>This overrides the global setting.</strong>  Or, use a \"properties\" step - the setting will apply to the NEXT run after the step is executed (same result).</p>\n</div>\n<div class=\"paragraph\">\n<p><span class=\"image center\"><img src=\"/images/post-images/2018-02-22-cheetah/pipeline-durability-highlighted.png\" alt=\"pipeline durability highlighted\"></span></p>\n</div>\n<div class=\"listingblock\">\n<div class=\"content\">\n<pre class=\"nowrap\">// Script //\nproperties([durabilityHint('PERFORMANCE_OPTIMIZED')])\n// Declarative //\npipeline {\n    agent any\n    stages {\n        stage('Example') {\n            steps {\n                echo 'Hello World'\n            }\n        }\n    }\n    options {\n        durabilityHint('PERFORMANCE_OPTIMIZED')\n    }\n}</pre>\n</div>\n</div>\n</div>\n<div class=\"sect2\">\n<h3 id=\"3-multibranch-projects-can-use-a-new-branchproperty-to-customize-the-durability-setting\"><a class=\"anchor\" href=\"#3-multibranch-projects-can-use-a-new-branchproperty-to-customize-the-durability-setting\"></a>3. <strong>Multibranch Projects</strong> can use a new BranchProperty to customize the Durability Setting.</h3>\n<div class=\"paragraph\">\n<p>Under the SCM you can configure a custom Branch Property Strategy and add a property for Custom Pipeline Speed/Durability Level.  This overrides the global Durability Setting and will apply to each branch at the next run.  You can also use a \"properties\" step to override the setting, but remember that you may have to run the step again to undo this.</p>\n</div>\n<div class=\"paragraph\">\n<p><span class=\"image center\"><img src=\"/images/post-images/2018-02-22-cheetah/multibranch-durability.png\" alt=\"multibranch durability\"></span></p>\n</div>\n<div class=\"paragraph\">\n<p>Durability settings will take effect with the next applicable Pipeline run, not immediately.  The setting will be displayed in the log.</p>\n</div>\n<div class=\"paragraph\">\n<p><span class=\"image center\"><img src=\"/images/post-images/2018-02-22-cheetah/durability-in-log-highlighted.png\" alt=\"durability in log highlighted\"></span></p>\n</div>\n<div class=\"paragraph\">\n<p>There is a slight durability trade-off for using the Performance-Optimized mode&#8201;&#8212;&#8201;<a href=\"/doc/book/pipeline/scaling-pipeline/#what-am-i-giving-up-with-this-durability-setting-trade-off\">the appropriate section of the Pipeline Scalability documentation</a> has the specifics.\nFor most uses we do not expect this to be important, but there are a few specific cases where users may wish to use a slower/higher-durability setting.  <a href=\"/doc/book/pipeline/scaling-pipeline/#suggested-best-practices-and-tips-for-durability-settings\">The Best Practices are documented.</a></p>\n</div>\n<div class=\"paragraph\">\n<p>We recommend using Performance-Optimized by default, but because it does represent a slight behavioral change the initial \"Cheetah\" plugin releases defaults to maintain previous behavior. We expect to switch this default in the future with appropriate notice once people have a chance to get used to the new settings.</p>\n</div>\n</div>\n</div>\n</div>\n<div class=\"sect1\">\n<h2 id=\"will-performance-optimized-mode-help-me\"><a class=\"anchor\" href=\"#will-performance-optimized-mode-help-me\"></a>Will Performance-Optimized Mode Help Me?</h2>\n<div class=\"sectionbody\">\n<div class=\"ulist\">\n<ul>\n<li>\n<p>Yes, if your Jenkins instance uses NFS, magnetic storage, runs many Pipelines at once, or shows high iowait (above 5%)</p>\n</li>\n<li>\n<p>Yes, if you are running Pipelines with many steps (more than several hundred).</p>\n</li>\n<li>\n<p>Yes, if your Pipeline stores large files or complex data to variables in the script, keeps that variable in scope for future use, and then runs steps.  This sounds oddly specific but happens more than you&#8217;d expect.</p>\n<div class=\"ulist\">\n<ul>\n<li>\n<p>For example: <code>readFile</code> step with a large XML/JSON file, or using configuration information from parsing such a file with <a href=\"https://jenkins.io/doc/pipeline/steps/pipeline-utility-steps/#code-readjson-code-read-json-from-files-in-the-workspace\">One of the Utility Steps</a>.</p>\n</li>\n<li>\n<p>Another common pattern is a \"summary\" object containing data from many branches (logs, results, or statistics). Often this is visible because you&#8217;ll be adding to it often via an add/append or <code>Map.put()</code> operations.</p>\n</li>\n<li>\n<p>Large arrays of data or Maps of configuration information are another common example of this situation.</p>\n</li>\n</ul>\n</div>\n</li>\n<li>\n<p>No, if your Pipelines spend almost all their time waiting for a few shell/batch steps to finish.  This ISN&#8217;T a magic \"go fast\" button for everything!</p>\n</li>\n<li>\n<p>No, if Pipelines are writing massive amounts of data to logs (logging is unchanged).</p>\n</li>\n<li>\n<p>No, if you are not using Pipelines, or your system is loaded down by other factors.</p>\n</li>\n<li>\n<p>No, if you don&#8217;t enable higher-performance modes for pipelines.  See above for how!</p>\n</li>\n</ul>\n</div>\n</div>\n</div>\n<div class=\"sect1\">\n<h2 id=\"other-goodies\"><a class=\"anchor\" href=\"#other-goodies\"></a>Other Goodies</h2>\n<div class=\"sectionbody\">\n<div class=\"ulist\">\n<ul>\n<li>\n<p>Users can now set an optional job property so that individual Pipelines fail cleanly rather than resuming upon restarting the controller.  This is useful for niche cases where some Pipelines are considered disposable and users would value a clean restart over Pipeline durability.</p>\n</li>\n<li>\n<p>We&#8217;ve reduced classloading and reflection quite significantly, which improves scaling and reduces CPU use:</p>\n</li>\n</ul>\n</div>\n<div class=\"paragraph\">\n<p><span class=\"image center\"><img src=\"/images/post-images/2018-02-22-cheetah/classloading.png\" alt=\"classloading\"></span></p>\n</div>\n<div class=\"ulist\">\n<ul>\n<li>\n<p>Script Security (as of version 1.41) has gotten optimizations to reduce the performance overhead of Sandbox mode and eliminate lock contention so Pipeline multithreads better.</p>\n</li>\n<li>\n<p>Pipeline Step data uses up less space on disk (regardless of the durability setting) - this should be 30% smaller.  Assume it&#8217;s a few MB per 1000 steps - but for every build after the change.</p>\n</li>\n<li>\n<p>Even in the low-performance/high-durability modes, some redundant writes have been removed, which decreases the number of writes by 10-20%.</p>\n</li>\n</ul>\n</div>\n</div>\n</div>\n<div class=\"sect1\">\n<h2 id=\"how-did-you-do-it\"><a class=\"anchor\" href=\"#how-did-you-do-it\"></a>How Did You Do It?</h2>\n<div class=\"sectionbody\">\n<div class=\"paragraph\">\n<p>That&#8217;s probably material for another blog post or <a href=\"https://www.cloudbees.com/jenkinsworld\">Jenkins World talk</a>.</p>\n</div>\n<div class=\"paragraph\">\n<p>The short answer is: first we built a tool to simulate a full production environment and provide detailed metrics collection at scale.  Then we profiled Jenkins to identify bottlenecks and attacked them.  Rinse and repeat.</p>\n</div>\n</div>\n</div>\n<div class=\"sect1\">\n<h2 id=\"what-next\"><a class=\"anchor\" href=\"#what-next\"></a>What Next?</h2>\n<div class=\"sectionbody\">\n<div class=\"paragraph\">\n<p>The next big change, which I&#8217;m calling Cheetah Part 2 is to address Pipeline&#8217;s logging. For every Step run, Pipeline writes one or more small log files. These log files are then copied into the build log content, but are retained to make it possible to easily fetch logs for each step.</p>\n</div>\n<div class=\"paragraph\">\n<p>This copying process means every log line is written twice, greatly reducing performance, and writing to many small files is orders of magnitude slower than appending to one big log file.</p>\n</div>\n<div class=\"paragraph\">\n<p>We&#8217;re going to remove this duplication and data fragmentation and use a more efficient mechanism to find per-step logs. This should further improve the ability to run Pipelines on NFS mounts and hard-drive-backed storage, and should significantly improve performance at scale.</p>\n</div>\n<div class=\"paragraph\">\n<p>Besides this, there&#8217;s a variety of different tactical improvements to improve scaling behavior and reduce resource needs.</p>\n</div>\n<div class=\"paragraph\">\n<p>The Project Cheetah work doesn&#8217;t free users to <em>completely ignore</em> <a href=\"/doc/book/pipeline/scaling-pipeline/\">Pipeline scaling best practices</a> and  <a href=\"/blog/2017/02/01/pipeline-scalability-best-practice/\">previous suggestions</a>.  Nor does it eliminate the need for <a href=\"/blog/2016/11/21/gc-tuning/\">efficient GC settings</a>.  But this and other enhancements from the last year <em>can</em> significantly improve the storage situation for most users and reduce the penalties for worst-case behaviors.  When you add all the pieces together, the result is a faster, leaner, more reliable Pipeline experience.</p>\n</div>\n</div>\n</div>","id":"d0c104fc-7582-5b71-ae72-ad7781b4796d","title":"Project Cheetah - Faster, Leaner Pipeline That Can Keep Up With Demand","date":"2018-02-22T00:00:00.000Z","slug":"/blog/2018/02/22/cheetah/","links":{"discourse":""},"authors":[]}},"pageContext":{"next":"/blog/2018/03/05/jenkins-world-talk-proposal-tips/","previous":"/blog/2018/02/19/gsoc2018-announcement/","id":"d0c104fc-7582-5b71-ae72-ad7781b4796d"}},
    "staticQueryHashes": ["1271460761","3649515864"]}